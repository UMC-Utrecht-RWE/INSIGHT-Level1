---
title: 'CONCEPTION - Level 1 checks: Step 4 to 5 (MEDICINES)'
output: 
  html_document:
    theme: spacelab
    toc: true
    toc_float: true
    toc_depth: 3
    output_dir: output_dir
---

```{r create_dir.m, include=FALSE}
if ("MEDICINES" %in% list.files(output_dir)){
  medicines_dir<-paste(output_dir, "MEDICINES/", sep="")
  medicines_less<-paste(medicines_dir, "Masked/", sep="")
   dir.create(paste(medicines_dir,"tmp", sep=""))
tmp<-paste(medicines_dir, "tmp/", sep="")
} else {
#Create the MEDICINES folder in the output dir
dir.create(paste(output_dir, "MEDICINES", sep=""))
  medicines_dir<-paste(output_dir, "MEDICINES/", sep="")
  dir.create(paste(medicines_dir,"Masked", sep=""))
medicines_less<-paste(medicines_dir, "Masked/", sep="")
   dir.create(paste(medicines_dir,"tmp", sep=""))
tmp<-paste(medicines_dir, "tmp/", sep="")
}
```

```{css,  echo = F}
/*-- Specify div's for 'boxes', change color of TOC and center align titles: --*/
div.box1 {background-color: #f5f5f0; border-radius: 5px; padding: 30px; margin-right: 0px}
div.box2 {border-style: solid; border-color: #f5f5f0; border-width: medium; border-radius: 30px; padding: 5px; margin-right: 0px}
div.box3 {border-style: solid; border-color: #f5f5f0; border-width: medium; border-radius: 30px; padding: 5px; margin-right: 0px}
div.box4 {border-style: solid; border-color: #f5f5f0; border-width: medium; border-radius: 30px; padding: 5px; margin-right: 0px}
div.box5 {border-style: solid; border-color: #f5f5f0; border-width: medium; border-radius: 30px; padding: 5px; margin-right: 0px}

.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {background-color: #76b82a; border-color: #76b82a}
h1 {text-align: center; color: #3c7b8a}
h2 {text-align: center; color: #76b82a}

/*-- Add logo (based on https://rstudio4edu.github.io/rstudio4edu-book/rmd-fancy.html): --*/
#TOC::before {content: ""; display: block; height: 60px; margin: 15px 10px 15px; background-image: url("conception_logo.png"); background-size: contain; background-position: center center; background-repeat: no-repeat}
```

```{r set_locale, include=FALSE}
Sys.setlocale("LC_ALL", "C")
`%!in%` = Negate(`%in%`)
```

``` {r list_of_variables, echo = FALSE}
total_var<-as.data.table( cbind(table_name="MEDICINES", 
        variable_name=c("person_id", "medicinal_product_id", "medicinal_product_atc_code", "date_dispensing", "date_prescription", "disp_number_medicinal_product",
                        "presc_quantity_per_day", "presc_quantity_unit", "presc_duration_days", "product_lot_number", "indication_code", "indication_code_vocabulary", "meaning_of_drug_record", "origin_of_drug_record", "prescriber_speciality", "prescriber_speciality_vocabulary", "visit_occurrence_id")))
```

```{r check_directory, include=FALSE}
#Get all files in the CDM directory that are .csv files
directory_CDM<-list.files(path_dir, pattern="\\.csv$")

#List of actual tables that match EVENTS pattern
actual_tables<-directory_CDM[grepl(pattern="MEDICINES", x=directory_CDM)]

```

```{r convention_check, include=FALSE}

#Check conventions
convention_check_medicines<-function(dt){

  con.1<-dt[(is.na(date_prescription) & is.na(date_dispensing)), .N]
  if (con.1!=0){
    error<-TRUE
    comment<-paste("Convention 1 is not satisfied.There is(are)", dt[(is.na(date_prescription) & is.na(date_dispensing)), .N], "observation(s) that have missing values in both variables date_prescription and date_dispensing")
  } else {
    error<-FALSE
    comment<-"Convention 1 is satisfied."
  }
  
   result<-data.table(error=error, comment=comment)
  return(result)
}

```

```{r count_functions, include=FALSE}
#Counts by meaning(other variables)
step4.1<-function(dt, var_name){
  dt[, meaning:= dt[[var_name]]]#Duplicate the meaning variable
  
  #medicinal_product_id
  c.1<-dt[complete.cases(meaning),lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c("medicinal_product_id"), by=.(meaning)] 
  c.1<-data.table::melt(c.1, id.vars=c("meaning"), measure.vars=colnames(c.1)[-1]) #from wide to long 
  setnames(c.1, "value", "count")
  c.2<-dt[complete.cases(meaning) & complete.cases(medicinal_product_id), .N]
  c.2<-data.table(variable="medicinal_product_id", total=c.2)
  
  #medicinal_product_atc_code
  d.1<-dt[complete.cases(meaning),lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c("medicinal_product_atc_code"), by=.(meaning)] 
  d.1<-data.table::melt(d.1, id.vars=c("meaning"), measure.vars=colnames(d.1)[-1]) #from wide to long 
  setnames(d.1, "value", "count")
  d.2<-dt[complete.cases(meaning) & complete.cases(medicinal_product_atc_code), .N]
  d.2<-data.table(variable="medicinal_product_atc_code", total=d.2)
  
  #disp_number_medicinal_product
  e.1<-dt[complete.cases(meaning),lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c("disp_number_medicinal_product"), by=.(meaning)] 
  e.1<-data.table::melt(e.1, id.vars=c("meaning"), measure.vars=colnames(e.1)[-1]) #from wide to long 
  setnames(e.1, "value", "count")
  e.2<-dt[complete.cases(meaning) & complete.cases(disp_number_medicinal_product), .N]
  e.2<-data.table(variable="disp_number_medicinal_product", total=e.2)
  
  #presc_quantity_per_day
  f.1<-dt[complete.cases(meaning),lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c("presc_quantity_per_day"), by=.(meaning)] 
  f.1<-data.table::melt(f.1, id.vars=c("meaning"), measure.vars=colnames(f.1)[-1]) #from wide to long 
  setnames(f.1, "value", "count")
  f.2<-dt[complete.cases(meaning) & complete.cases(presc_quantity_per_day), .N]
  f.2<-data.table(variable="presc_quantity_per_day", total=f.2)
  
  #presc_duration_days
  g.1<-dt[complete.cases(meaning),lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c("presc_duration_days"), by=.(meaning)] 
  g.1<-data.table::melt(g.1, id.vars=c("meaning"), measure.vars=colnames(g.1)[-1]) #from wide to long 
  setnames(g.1, "value", "count")
  g.2<-dt[complete.cases(meaning) & complete.cases(presc_duration_days), .N]
  g.2<-data.table(variable="presc_duration_days", total=g.2)
  
  #product_lot_number
  h.1<-dt[complete.cases(meaning),lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c("product_lot_number"), by=.(meaning)] 
  h.1<-data.table::melt(h.1, id.vars=c("meaning"), measure.vars=colnames(h.1)[-1]) #from wide to long 
  setnames(h.1, "value", "count")
  h.2<-dt[complete.cases(meaning) & complete.cases(product_lot_number), .N]
  h.2<-data.table(variable="product_lot_number", total=h.2)
  
  #indication_code
  i.1<-dt[complete.cases(meaning),lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c("indication_code"), by=.(meaning)] 
  i.1<-data.table::melt(i.1, id.vars=c("meaning"), measure.vars=colnames(i.1)[-1]) #from wide to long 
  setnames(i.1, "value", "count")
  i.2<-dt[complete.cases(meaning) & complete.cases(indication_code), .N]
  i.2<-data.table(variable="indication_code", total=i.2)
  
    #prescriber_speciality
  j.1<-dt[complete.cases(meaning),lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c("prescriber_speciality"), by=.(meaning)] 
  j.1<-data.table::melt(j.1, id.vars=c("meaning"), measure.vars=colnames(j.1)[-1]) #from wide to long 
  setnames(j.1, "value", "count")
  j.2<-dt[complete.cases(meaning) & complete.cases(prescriber_speciality), .N]
  j.2<-data.table(variable="prescriber_speciality", total=j.2)
  
  
  count<-rbind(c.1,d.1,e.1, f.1, g.1, h.1, i.1, j.1)
  total<-rbind(c.2,d.2,e.2, f.2, g.2, h.2, i.2, j.2)
  results<-list("count"=count, "total"=total)
  return(results)
}

#################################################################
#Counts by meaning and year (other variables)
step4.2<-function(dt, var_name){
  dt[, meaning:= dt[[var_name]]]#Duplicate the meaning variable

  #medicinal_product_id
  c.1<-dt[complete.cases(meaning) & complete.cases(year),lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c("medicinal_product_id"), by=.(meaning, year)] 
  c.1<-data.table::melt(c.1, id.vars=c("meaning", "year"), measure.vars=colnames(c.1)[-c(1:2)]) #from wide to long  
  setnames(c.1, "value", "count")
  c.2<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(medicinal_product_id), .N, by=.(year)]
  setnames(c.2, "N", "total")
  c.2<-data.table(variable="medicinal_product_id", c.2)
  
  
  #medicinal_product_atc_code
  d.1<-dt[complete.cases(meaning) & complete.cases(year),lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c("medicinal_product_atc_code"), by=.(meaning, year)] 
  d.1<-data.table::melt(d.1, id.vars=c("meaning", "year"), measure.vars=colnames(d.1)[-c(1:2)]) #from wide to long  
  setnames(d.1, "value", "count")
  d.2<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(medicinal_product_atc_code), .N, by=.(year)]
  setnames(d.2, "N", "total")
  d.2<-data.table(variable="medicinal_product_atc_code", d.2)
  
  
  #disp_number_medicinal_product
  e.1<-dt[complete.cases(meaning) & complete.cases(year),lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c("disp_number_medicinal_product"), by=.(meaning, year)] 
  e.1<-data.table::melt(e.1, id.vars=c("meaning", "year"), measure.vars=colnames(e.1)[-c(1:2)]) #from wide to long  
  setnames(e.1, "value", "count")
  e.2<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(disp_number_medicinal_product), .N, by=.(year)]
  setnames(e.2, "N", "total")
  e.2<-data.table(variable="disp_number_medicinal_product", e.2)
  
  #presc_quantity_per_day
  f.1<-dt[complete.cases(meaning) & complete.cases(year),lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c("presc_quantity_per_day"), by=.(meaning, year)] 
  f.1<-data.table::melt(f.1, id.vars=c("meaning", "year"), measure.vars=colnames(f.1)[-c(1:2)]) #from wide to long  
  setnames(f.1, "value", "count")
  f.2<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(presc_quantity_per_day), .N, by=.(year)]
  setnames(f.2, "N", "total")
  f.2<-data.table(variable="presc_quantity_per_day", f.2)
  
  #presc_duration_days
  g.1<-dt[complete.cases(meaning) & complete.cases(year),lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c("presc_duration_days"), by=.(meaning, year)] 
  g.1<-data.table::melt(g.1, id.vars=c("meaning", "year"), measure.vars=colnames(g.1)[-c(1:2)]) #from wide to long  
  setnames(g.1, "value", "count")
  g.2<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(presc_duration_days), .N, by=.(year)]
  setnames(g.2, "N", "total")
  g.2<-data.table(variable="presc_duration_days", g.2)
  
  #product_lot_number
  h.1<-dt[complete.cases(meaning) & complete.cases(year),lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c("product_lot_number"), by=.(meaning, year)] 
  h.1<-data.table::melt(h.1, id.vars=c("meaning", "year"), measure.vars=colnames(h.1)[-c(1:2)]) #from wide to long  
  setnames(h.1, "value", "count")
  h.2<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(product_lot_number), .N, by=.(year)]
  setnames(h.2, "N", "total")
  h.2<-data.table(variable="product_lot_number", h.2)
  
    #indication_code
  i.1<-dt[complete.cases(meaning) & complete.cases(year),lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c("indication_code"), by=.(meaning, year)] 
  i.1<-data.table::melt(i.1, id.vars=c("meaning", "year"), measure.vars=colnames(i.1)[-c(1:2)]) #from wide to long  
  setnames(i.1, "value", "count")
  i.2<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(indication_code), .N, by=.(year)]
  setnames(i.2, "N", "total")
  i.2<-data.table(variable="indication_code", i.2)
  
      #prescriber_speciality
  j.1<-dt[complete.cases(meaning) & complete.cases(year),lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c("prescriber_speciality"), by=.(meaning, year)] 
  j.1<-data.table::melt(j.1, id.vars=c("meaning", "year"), measure.vars=colnames(j.1)[-c(1:2)]) #from wide to long  
  setnames(j.1, "value", "count")
  j.2<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(prescriber_speciality), .N, by=.(year)]
  setnames(j.2, "N", "total")
  j.2<-data.table(variable="prescriber_speciality", j.2)
  
  count<-rbind(c.1,d.1,e.1,f.1,g.1,h.1, i.1, j.1)
  total<-rbind(c.2,d.2,e.2,f.2,g.2,h.2, i.2, j.2)
  results<-list("count"=count, "total"=total)
  return(results)
}

####################################################################################
#Counts by meaning (2 or more categories)
step4.3<-function(dt, var_name){
  dt[, meaning:= dt[[var_name]]]#Duplicate the meaning variable
  
  #presc_quantity_unit
  a.1<-dt[complete.cases(meaning), .(count=.N), by=.(meaning, presc_quantity_unit)]
  setnames(a.1, "presc_quantity_unit", "vocabulary")
  a.1<-cbind(a.1, variable="presc_quantity_unit")
  a.2<-dt[complete.cases(meaning) & complete.cases(presc_quantity_unit), .N]
  a.2<-data.table(variable="presc_quantity_unit", total=a.2)
  
  #indication_code_vocabulary
  b.1<-dt[complete.cases(meaning), .(count=.N), by=.(meaning, indication_code_vocabulary)]
  setnames(b.1, "indication_code_vocabulary", "vocabulary")
  b.1<-cbind(b.1, variable="indication_code_vocabulary")
  b.2<-dt[complete.cases(meaning) & complete.cases(indication_code_vocabulary), .N]
  b.2<-data.table(variable="indication_code_vocabulary", total=b.2)
  
  #meaning_of_drug_record
  c.1<-dt[complete.cases(meaning), .(count=.N), by=.(meaning, meaning_of_drug_record)]
  setnames(c.1, "meaning_of_drug_record", "vocabulary")
  c.1<-cbind(c.1, variable="meaning_of_drug_record")
  c.2<-dt[complete.cases(meaning) & complete.cases(meaning_of_drug_record), .N]
  c.2<-data.table(variable="meaning_of_drug_record", total=c.2)
  
  
  #origin_of_drug_record
  d.1<-dt[, .(count=.N), by=.(meaning, origin_of_drug_record)]
  setnames(d.1, "origin_of_drug_record", "vocabulary")
  d.1<-cbind(d.1, variable="origin_of_drug_record")
  d.2<-dt[complete.cases(meaning) & complete.cases(origin_of_drug_record), .N]
  d.2<-data.table(variable="origin_of_drug_record", total=d.2)
  
  #prescriber_speciality_vocabulary
  e.1<-dt[, .(count=.N), by=.(meaning, prescriber_speciality_vocabulary)]
  setnames(e.1, "prescriber_speciality_vocabulary", "vocabulary")
  e.1<-cbind(e.1, variable="prescriber_speciality_vocabulary")
  e.2<-dt[complete.cases(meaning) & complete.cases(prescriber_speciality_vocabulary), .N]
  e.2<-data.table(variable="prescriber_speciality_vocabulary", total=e.2)
  
  count<-rbind(a.1,b.1,c.1,d.1,e.1)
  total<-rbind(a.2,b.2,c.2,d.2,e.2)
  results<-list("count"=count, "total"=total)
  return(results)
}

################################################################################

#Count by meaning and year (2 or more categories)
step4.4<-function(dt, var_name){

  dt[, meaning:= dt[[var_name]]]#Duplicate the meaning variable
  
  #presc_quantity_unit
  a.1<-dt[complete.cases(meaning) & complete.cases(year), .(count=.N), by=.(meaning, year, presc_quantity_unit)]
  setnames(a.1, "presc_quantity_unit", "vocabulary")
  a.1<-cbind(a.1, variable="presc_quantity_unit")
  a.2<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(presc_quantity_unit), .N, by=.(year)]
  setnames(a.2, "N", "total")
  a.2<-data.table(variable="presc_quantity_unit", a.2)
  
  #indication_code_vocabulary
  b.1<-dt[complete.cases(meaning) & complete.cases(year), .(count=.N), by=.(meaning, year, indication_code_vocabulary)]
  setnames(b.1, "indication_code_vocabulary", "vocabulary")
  b.1<-cbind(b.1, variable="indication_code_vocabulary")
  b.2<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(indication_code_vocabulary), .N, by=.(year)]
  setnames(b.2, "N", "total")
  b.2<-data.table(variable="indication_code_vocabulary", b.2)
  
  #meaning_of_drug_record
  c.1<-dt[complete.cases(meaning) & complete.cases(year), .(count=.N), by=.(meaning, year, meaning_of_drug_record)]
  setnames(c.1, "meaning_of_drug_record", "vocabulary")
  c.1<-cbind(c.1, variable="meaning_of_drug_record")
  c.2<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(meaning_of_drug_record), .N, by=.(year)]
  setnames(c.2, "N", "total")
  c.2<-data.table(variable="meaning_of_drug_record", c.2)
  
  #origin_of_drug_record
  d.1<-dt[complete.cases(meaning) & complete.cases(year), .(count=.N), by=.(meaning, year, origin_of_drug_record)]
  setnames(d.1, "origin_of_drug_record", "vocabulary")
  d.1<-cbind(d.1, variable="origin_of_drug_record")
  d.2<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(origin_of_drug_record), .N, by=.(year)]
  setnames(d.2, "N", "total")
  d.2<-data.table(variable="origin_of_drug_record", d.2)
  
  #prescriber_speciality_vocabulary
  e.1<-dt[complete.cases(meaning) & complete.cases(year), .(count=.N), by=.(meaning, year, prescriber_speciality_vocabulary)]
  setnames(e.1, "prescriber_speciality_vocabulary", "vocabulary")
  e.1<-cbind(e.1, variable="prescriber_speciality_vocabulary")
  e.2<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(prescriber_speciality_vocabulary), .N, by=.(year)]
  setnames(e.2, "N", "total")
  e.2<-data.table(variable="prescriber_speciality_vocabulary", e.2)
  
  count<-rbind(a.1,b.1,c.1,d.1, e.1)
  total<-rbind(a.2,b.2,c.2,d.2, e.2)
  results<-list("count"=count, "total"=total)
  return(results)
}

```

```{r date_count_functions, include=FALSE}
#Date counts by meaning
dates_count.m<-function(dt, var_name, date_var1, date_var2){
  dt[, meaning:= dt[[var_name]]]#Duplicate the meaning variable
  
  if (!(is.null(date_var2))){
  a.1<-dt[complete.cases(meaning), lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c(date_var1, date_var2), by= .(meaning)]
  a.1<-data.table::melt(a.1, id.vars=c("meaning"), measure.vars=colnames(a.1)[-1])
  setnames(a.1, "value", "count")
  a.2.0<-dt[complete.cases(meaning) & complete.cases(date_var1), .N]
  a.2.0<-data.table(variable=date_var1, total=a.2.0)
  a.2.1<-dt[complete.cases(meaning) & complete.cases(date_var2), .N]
  a.2.1<-data.table(variable=date_var2, total=a.2.1)
  a.2<-rbind(a.2.0, a.2.1)

  results<-list("count"=a.1, "total"=a.2)
  return(results)
 
  } else {
    a.1<-dt[complete.cases(meaning), lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c(date_var1), by= .(meaning)]
    a.1<-data.table::melt(a.1, id.vars=c("meaning"), measure.vars=colnames(a.1)[-1])
    setnames(a.1, "value", "count")
    a.2<-dt[complete.cases(meaning) & complete.cases(date_var1), .N]
   a.2<-data.table("variable"=date_var1, total=a.2)
   
   results<-list("count"=a.1, "total"=a.2)
   return(results)
  }
}


#Date counts by meaning and year
dates_count.my<-function(dt, var_name, date_var1, date_var2){
  dt[, meaning:= dt[[var_name]]]#Duplicate the meaning variable
  
  #Check if the second argument is present
  if( !(is.null(date_var2))){
 
#Check if date_var1 is completely empty 
if (dt[is.na(dt[[date_var1]]), .N]==dt[,.N]){
#Check if date_var2 is completely empty
  if (dt[is.na(dt[[date_var2]]), .N]==dt[,.N]){
    print("This check can not be performed since both date variables are completely empty.")
  } else {
    #Create year variable based on date_var2 since date_var1 is completely empty.
    dt[,year:=substr(get(date_var2), 1, 4)]
    
    #Continue with count function
    a.1<-dt[complete.cases(meaning) & complete.cases(year), lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c(date_var1, date_var2), by= .(meaning, year)]
  a.1<-data.table::melt(a.1, id.vars=c("meaning", "year"), measure.vars=colnames(a.1)[-c(1:2)])
  setnames(a.1, "value", "count")
  a.2.0<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(date_var1), .N, by=.(year)]
  a.2.0<-data.table(variable=date_var1, a.2.0)
  a.2.1<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(date_var2), .N, by=.(year)]
  a.2.1<-data.table(variable=date_var2, a.2.1)
  a.2<-rbind(a.2.0, a.2.1)
  setnames(a.2, "N", "total")
  a.2[variable==date_var1, ("total"):=0]
  
  results<-list("count"=a.1, "total"=a.2)
  return(results)
  }
} else {
#Check if date_var2 is completely empty
  if (dt[is.na(dt[[date_var2]]), .N]==dt[,.N]){
   #Create year variable based on date_var1 since date_var2 is completely empty.
    dt[,year:=substr(get(date_var1), 1, 4)]
    
    #Continue with count function
    a.1<-dt[complete.cases(meaning) & complete.cases(year), lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c(date_var1, date_var2), by= .(meaning, year)]
  a.1<-data.table::melt(a.1, id.vars=c("meaning", "year"), measure.vars=colnames(a.1)[-c(1:2)])
  setnames(a.1, "value", "count")
  a.2.0<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(date_var1), .N, by=.(year)]
  a.2.0<-data.table(variable=date_var1, a.2.0)
  a.2.1<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(date_var2), .N, by=.(year)]
  a.2.1<-data.table(variable=date_var2, a.2.1)
  a.2<-rbind(a.2.0, a.2.1)
  setnames(a.2, "N", "total")
  a.2[variable==date_var2, ("total"):=0]
  
  results<-list("count"=a.1, "total"=a.2)
  return(results)
  } else {
  #There will be two year variables created one for date_var1 and one for date_var2
    dt[,year1:=substr(get(date_var1), 1, 4)] 
    dt[,year2:=substr(get(date_var2), 1, 4)] 
    
    a.1.1<-dt[complete.cases(meaning) & complete.cases(year1), lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c(date_var1), by= .(meaning, year1)]
  a.1.1<-data.table::melt(a.1.1, id.vars=c("meaning", "year1"), measure.vars=colnames(a.1.1)[-c(1:2)])
  setnames(a.1.1, "value", "count")
  setnames(a.1.1, "year1", "year")
      a.1.2<-dt[complete.cases(meaning) & complete.cases(year2), lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c(date_var2), by= .(meaning, year2)]
  a.1.2<-data.table::melt(a.1.2, id.vars=c("meaning", "year2"), measure.vars=colnames(a.1.2)[-c(1:2)])
  setnames(a.1.2, "value", "count")
  setnames(a.1.2, "year2", "year")
  a.1<-rbind(a.1.1, a.1.2)
  a.2.0<-dt[complete.cases(meaning) & complete.cases(year1), .N, by=.(year1)]
  setnames(a.2.0, "year1", "year")
  a.2.0<-data.table(variable=date_var1, a.2.0)
  a.2.1<-dt[complete.cases(meaning) & complete.cases(year2), .N, by=.(year2)]
  setnames(a.2.1, "year2", "year")
  a.2.1<-data.table(variable=date_var2, a.2.1)
  a.2<-rbind(a.2.0, a.2.1)
  setnames(a.2, "N", "total")
  
  results<-list("count"=a.1, "total"=a.2)
    return(results)
  }
}
  } else {
    
    #Create year variable based on date_var1 since only one date is provided
    dt[,year:=substr(get(date_var1), 1, 4)]
    
    a.1<-dt[complete.cases(meaning) & complete.cases(year), lapply(.SD, FUN=function(x) sum(complete.cases(x))), .SDcols=c(date_var1), by= .(meaning, year)]
    a.1<-data.table::melt(a.1, id.vars=c("meaning", "year"), measure.vars=colnames(a.1)[-c(1:2)])
    setnames(a.1, "value", "count")
    a.2<-dt[complete.cases(meaning) & complete.cases(year) & complete.cases(date_var1), .N, by=.(year)]
    setnames(a.2, "N", "total")
    a.2<-data.table(variable=date_var1, a.2)
    
    results<-list("count"=a.1, "total"=a.2)
    return(results)
  }
}
```

```{r distribution_functions, include=FALSE}
#Distribution by meaning
distribution_meaning<-function(dt, var){
  mean.m<-dt[, lapply(.SD, mean), .SDcols=c(var), by=.(meaning_of_drug_record)]
  setnames(mean.m, "meaning_of_drug_record", "meaning")
  setnames(mean.m, var, "mean")
  sd.m<-dt[, lapply(.SD, sd), .SDcols=c(var), by=.(meaning_of_drug_record)]
  setnames(sd.m, "meaning_of_drug_record", "meaning")
  setnames(sd.m, var, "SD")
  median.m<-dt[, lapply(.SD, median), .SDcols=c(var), by=.(meaning_of_drug_record)]
  setnames(median.m, "meaning_of_drug_record", "meaning")
  setnames(median.m, var, "median")
  iqr.m<- dt[, lapply(.SD, IQR), .SDcols=c(var), by=.(meaning_of_drug_record)]
  setnames(iqr.m, "meaning_of_drug_record", "meaning")
  setnames(iqr.m, var, "IQR")
  skewness.m<-dt[, lapply(.SD, skewness), .SDcols=c(var), by=.(meaning_of_drug_record)]  
  setnames(skewness.m, "meaning_of_drug_record", "meaning")
  setnames(skewness.m, var, "skewness")
  kurtosis.m<-dt[, lapply(.SD, kurtosis), .SDcols=c(var), by=.(meaning_of_drug_record)]  
  setnames(kurtosis.m, "meaning_of_drug_record", "meaning")
  setnames(kurtosis.m, var, "kurtosis")
  dist.m<-cbind(mean.m, sd.m[,2], median.m[,2], iqr.m[,2], skewness.m[,2],kurtosis.m[,2])
  return(dist.m)
}

#Distribution by meaning and year
distribution_meaning_year<-function(dt, var){
  
  mean.my<-dt[, lapply(.SD, mean), .SDcols=c(var), by=.(meaning_of_drug_record, year)]
  setnames(mean.my, "meaning_of_drug_record", "meaning")
  setnames(mean.my, var, "mean")
  sd.my<-dt[, lapply(.SD, sd), .SDcols=c(var), by=.(meaning_of_drug_record, year)]
  setnames(sd.my, "meaning_of_drug_record", "meaning")
  setnames(sd.my, var, "SD")
  median.my<-dt[, lapply(.SD, median), .SDcols=c(var), by=.(meaning_of_drug_record, year)]
  setnames(median.my, "meaning_of_drug_record", "meaning")
  setnames(median.my, var, "median")
  iqr.my<- dt[, lapply(.SD, IQR), .SDcols=c(var), by=.(meaning_of_drug_record, year)]
  setnames(iqr.my, "meaning_of_drug_record", "meaning")
  setnames(iqr.my, var, "IQR")
  skewness.my<-dt[, lapply(.SD, skewness), .SDcols=c(var), by=.(meaning_of_drug_record, year)]  
  setnames(skewness.my, "meaning_of_drug_record", "meaning")
  setnames(skewness.my, var, "skewness")
  kurtosis.my<-dt[, lapply(.SD, kurtosis), .SDcols=c(var), by=.(meaning_of_drug_record, year)]  
  setnames(kurtosis.my, "meaning_of_drug_record", "meaning")
  setnames(kurtosis.my,var, "kurtosis")
  
  dist.my<-cbind(mean.my, sd.my[,3], median.my[,3], iqr.my[,3], skewness.my[,3],kurtosis.my[,3])
  return(dist.my)
}

#Distribution by meaning and unit
distribution_meaning_unit<-function(dt, var){
  mean.my<-dt[, lapply(.SD, mean), .SDcols=c(var), by=.(meaning_of_drug_record, presc_quantity_unit)]
  setnames(mean.my, "meaning_of_drug_record", "meaning")
  setnames(mean.my, var, "mean")
  setnames(mean.my, "presc_quantity_unit", "unit")
  sd.my<-dt[, lapply(.SD, sd), .SDcols=c(var), by=.(meaning_of_drug_record, presc_quantity_unit)]
  setnames(sd.my, "meaning_of_drug_record", "meaning")
  setnames(sd.my, var, "SD")
  setnames(sd.my, "presc_quantity_unit", "unit")
  median.my<-dt[, lapply(.SD, median), .SDcols=c(var), by=.(meaning_of_drug_record, presc_quantity_unit)]
  setnames(median.my, "meaning_of_drug_record", "meaning")
  setnames(median.my, var, "median")
  setnames(median.my, "presc_quantity_unit", "unit")
  iqr.my<- dt[, lapply(.SD, IQR), .SDcols=c(var), by=.(meaning_of_drug_record, presc_quantity_unit)]
  setnames(iqr.my, "meaning_of_drug_record", "meaning")
  setnames(iqr.my, var, "IQR")
  setnames(iqr.my, "presc_quantity_unit", "unit")
  skewness.my<-dt[, lapply(.SD, skewness), .SDcols=c(var), by=.(meaning_of_drug_record, presc_quantity_unit)]  
  setnames(skewness.my, "meaning_of_drug_record", "meaning")
  setnames(skewness.my, var, "skewness")
  setnames(skewness.my, "presc_quantity_unit", "unit")
  kurtosis.my<-dt[, lapply(.SD, kurtosis), .SDcols=c(var), by=.(meaning_of_drug_record, presc_quantity_unit)]  
  setnames(kurtosis.my, "meaning_of_drug_record", "meaning")
  setnames(kurtosis.my,var, "kurtosis")
  setnames(kurtosis.my, "presc_quantity_unit", "unit")
  
  dist.my<-cbind(mean.my, sd.my[,3], median.my[,3], iqr.my[,3], skewness.my[,3],kurtosis.my[,3])
  return(dist.my)
}

#Distribution by meaning and year, unit
distribution_meaning_unit_year<-function(dt, var){
  mean.my<-dt[, lapply(.SD, mean), .SDcols=c(var), by=.(meaning_of_drug_record, year, presc_quantity_unit)]
  setnames(mean.my, "meaning_of_drug_record", "meaning")
  setnames(mean.my, var, "mean")
  setnames(mean.my, "presc_quantity_unit", "unit")
  sd.my<-dt[, lapply(.SD, sd), .SDcols=c(var), by=.(meaning_of_drug_record, year, presc_quantity_unit)]
  setnames(sd.my, "meaning_of_drug_record", "meaning")
  setnames(sd.my, var, "SD")
  setnames(sd.my, "presc_quantity_unit", "unit")
  median.my<-dt[, lapply(.SD, median), .SDcols=c(var), by=.(meaning_of_drug_record, year, presc_quantity_unit)]
  setnames(median.my, "meaning_of_drug_record", "meaning")
  setnames(median.my, var, "median")
  setnames(median.my, "presc_quantity_unit", "unit")
  iqr.my<- dt[, lapply(.SD, IQR), .SDcols=c(var), by=.(meaning_of_drug_record, year, presc_quantity_unit)]
  setnames(iqr.my, "meaning_of_drug_record", "meaning")
  setnames(iqr.my, var, "IQR")
  setnames(iqr.my, "presc_quantity_unit", "unit")
  skewness.my<-dt[, lapply(.SD, skewness), .SDcols=c(var), by=.(meaning_of_drug_record, year, presc_quantity_unit)]  
  setnames(skewness.my, "meaning_of_drug_record", "meaning")
  setnames(skewness.my, var, "skewness")
  setnames(skewness.my, "presc_quantity_unit", "unit")
  kurtosis.my<-dt[, lapply(.SD, kurtosis), .SDcols=c(var), by=.(meaning_of_drug_record, year, presc_quantity_unit)]  
  setnames(kurtosis.my, "meaning_of_drug_record", "meaning")
  setnames(kurtosis.my,var, "kurtosis")
  setnames(kurtosis.my, "presc_quantity_unit", "unit")
  
  dist.my<-cbind(mean.my, sd.my[,4], median.my[,4], iqr.my[,4], skewness.my[,4],kurtosis.my[,4])
  return(dist.my)
}

```

```{r combine_results_functions, include=FALSE}
#Combine results when counts only by meaning(other variables, dates)
combine_counts1.m<-function(counts_dt, totals_dt){
  a<-counts_dt[,combination:= paste(variable, meaning, sep=":")]
  a.1<-a[,.(count, combination)]
  a.2<-a.1[, lapply(.SD, sum), by=.(combination)]
  a.2[, paste0("combination", 1:2) := tstrsplit(combination, ":")]
  setnames(a.2, "combination1", "variable")
  setnames(a.2, "combination2", "meaning")
  a.2[, combination:=NULL]
  setcolorder(a.2, c("variable", "meaning", "count"))
  
  b<-totals_dt[, lapply(.SD, sum), by=.(variable)]
  
  setkey(a.2, variable)
  setkey(b, variable)
  results<-merge.data.table(a.2, b, all.x = TRUE)
  results[is.na(total), "total"]<-0
return(results)
}

#Combine results when counts only by meaning and year(other variables, dates)
combine_counts1.my<-function(counts_dt, totals_dt){
  a<-counts_dt[,combination:= paste(variable, meaning, year, sep=":")]
  a.1<-a[,.(count, combination)]
  a.2<-a.1[, lapply(.SD, sum), by=.(combination)]
  a.2[, paste0("combination", 1:3) := tstrsplit(combination, ":")]
  setnames(a.2, "combination1", "variable")
  setnames(a.2, "combination2", "meaning")
  setnames(a.2, "combination3", "year")
  a.2[, combination:=NULL]
  setcolorder(a.2, c("variable", "meaning", "year", "count"))
  
  
  b<-totals_dt[,combination:= paste(variable, year, sep=":")]
  b.1<-b[,.(total, combination)]
  b.2<-b.1[, lapply(.SD, sum), by=.(combination)]
  b.2[, paste0("combination", 1:2) := tstrsplit(combination, ":")]
  setnames(b.2, "combination1", "variable")
  setnames(b.2, "combination2", "year")
  b.2[, combination:=NULL]
  
  setkey(a.2, variable, year)
  setkey(b.2, variable, year)
  results<-merge.data.table(a.2, b.2, all.x = TRUE)
  results[is.na(total), "total"]<-0
setcolorder(results, c("variable", "meaning", "year", "count", "total"))
  return(results)
}

#Combine results when counts only by meaning(2 or more categories)
combine_counts2.m<-function(counts_dt, totals_dt){
  a<-counts_dt[,combination:= paste(variable, meaning, vocabulary, sep=":")]
  a.1<-a[,.(count, combination)]
  a.2<-a.1[, lapply(.SD, sum), by=.(combination)]
  a.2[, paste0("combination", 1:3) := tstrsplit(combination, ":")]
  setnames(a.2, "combination1", "variable")
  setnames(a.2, "combination2", "meaning")
  setnames(a.2, "combination3", "vocabulary")
  a.2[, combination:=NULL]
  setcolorder(a.2, c("variable", "meaning", "vocabulary", "count"))
  
  b<-totals_dt[,lapply(.SD, sum), by=.(variable)]
  
  setkey(a.2, variable)
  setkey(b, variable)
  results<-merge.data.table(a.2, b, all.x = TRUE)
  results[is.na(total), "total"]<-0
  return(results)

}

#Combine results when counts only by meaning and year and with 2 or more categories
combine_counts2.my<-function(counts_dt, totals_dt){
  
  a<-counts_dt[,combination:= paste(variable, meaning, vocabulary, year, sep=":")]
  a.1<-a[,.(count, combination)]
  a.2<-a.1[, lapply(.SD, sum), by=.(combination)]
  a.2[, paste0("combination", 1:4) := tstrsplit(combination, ":")]
  setnames(a.2, "combination1", "variable")
  setnames(a.2, "combination2", "meaning")
  setnames(a.2, "combination3", "vocabulary")
  setnames(a.2, "combination4", "year")
  a.2[, combination:=NULL]
  setcolorder(a.2, c("variable", "meaning", "vocabulary", "year", "count"))
  
  
  b<-totals_dt[,combination:= paste(variable, year, sep=":")]
  b.1<-b[,.(total, combination)]
  b.2<-b.1[, lapply(.SD, sum), by=.(combination)]
  b.2[, paste0("combination", 1:2) := tstrsplit(combination, ":")]
  setnames(b.2, "combination1", "variable")
  setnames(b.2, "combination2", "year")
  b.2[, combination:=NULL]

  setkey(a.2, variable, year)
  results<-merge.data.table(a.2, b.2, all.x = TRUE)
  results[is.na(total), "total"]<-0
  setcolorder(results, c("variable", "meaning", "vocabulary", "year", "count", "total"))
  return(results)
  
}
```

```{r step4_5_check, include=FALSE}
step_4_5_check<- function(tables_list){
  Res.convention<-list()
  Res.4.1<-list()
  Res.4.2<-list()
  Res.4.3<-list()
  Res.4.4<-list()
  Res.dates.m<-list()
  Res.dates.my<-list()
  Res.p.t<-list() #total number of persons with recorded meaning
  Res.v.t<-list() #total number of visits with recorded meaning
  Res.p.t.y<-list() #total number of persons with recorded meaning and year
  Res.v.t.y<-list() #total number of visits with recorded meaning and year
  dist.disp<-list()
  dist.pres<-list()
  dist.dur<-list()
  w<-1
  for (i in 1:length(tables_list)){
    
    df<- fread(paste(path_dir, tables_list[i], sep=""), stringsAsFactors = FALSE, colClasses = "character")
    df<-df[, lapply(.SD, FUN=function(x) gsub("^$|^ $", NA, x))]

    df[,year:=substr(date_prescription, 1, 4)][!is.na(date_dispensing),year:=substr(date_dispensing, 1, 4)]

         #Create a combination variable by combining all columns, keep only that variable
    cols<-colnames(df)
    # dup<-df[, combination := Reduce(function(...) paste(..., sep = "_^_"), .SD[, mget(cols)])][,"combination"]
    # 
    # write.csv(dup, paste(tmp,"dup_", tables_list[i],sep="") ,row.names = F)
    # rm(dup)
    
    
  #Create the dataset with the variables needed for distribution of continuous variables
    dist.disp<-df[!is.na(disp_number_medicinal_product) & !is.na(meaning_of_drug_record), c("meaning_of_drug_record", "disp_number_medicinal_product", "date_dispensing")]
    if (dist.disp[,.N]>0){
    write.csv(dist.disp, paste(tmp,"dist.disp_", tables_list[i],sep="") ,row.names = F)
     }
    rm(dist.disp)
    
    dist.pres<-df[!is.na(presc_quantity_per_day) & !is.na(presc_quantity_unit) & !is.na(meaning_of_drug_record), c("presc_quantity_per_day", "presc_quantity_unit", "meaning_of_drug_record", "date_prescription")]
     if (dist.pres[,.N]>0){
    write.csv(dist.pres, paste(tmp,"dist.pres_", tables_list[i],sep="") ,row.names = F)
     }
    rm(dist.pres)
    
    dist.dur<-df[!is.na(presc_duration_days) & !is.na(meaning_of_drug_record), c("presc_duration_days", "meaning_of_drug_record", "date_prescription")]
     if (dist.dur[,.N]>0){
    write.csv(dist.dur, paste(tmp,"dist.dur_", tables_list[i],sep="") ,row.names = F)
     }
    rm(dist.dur)
    
    
    Res.convention[[w]]<-data.table(table_name="MEDICINES", table_directory=tables_list[i], convention_check_medicines(dt=df))
    Res.4.1[[w]]<-step4.1(dt=df, var_name = "meaning_of_drug_record")
    Res.4.2[[w]]<-step4.2(dt=df, var_name = "meaning_of_drug_record")
    Res.4.3[[w]]<-step4.3(dt=df, var_name = "meaning_of_drug_record")
    Res.4.4[[w]]<-step4.4(dt=df, var_name = "meaning_of_drug_record")
    Res.p<-df[, c("person_id", "year", "meaning_of_drug_record")][!is.na(person_id)][!is.na(meaning_of_drug_record)]
      write.csv(Res.p, paste(tmp,"persons_", tables_list[i],sep="") ,row.names = F)
    rm(Res.p)
    
    Res.v<-df[, c("visit_occurrence_id", "year", "meaning_of_drug_record")][!is.na(visit_occurrence_id)][!is.na(meaning_of_drug_record)]
    if (Res.v[,.N]>0){
      write.csv(Res.v, paste(tmp,"visits_", tables_list[i],sep="") ,row.names = F)
    rm(Res.v)
    }
        Res.p.t[[w]]<-df[!is.na(meaning_of_drug_record) & !is.na(person_id), .N]
    Res.p.t.y[[w]]<-df[!is.na(meaning_of_drug_record) & !is.na(person_id),.(total=.N), by="year"][!is.na(year)]
    Res.v.t[[w]]<-df[!is.na(meaning_of_drug_record) & !is.na(visit_occurrence_id), .N]
    Res.v.t.y[[w]]<-df[!is.na(meaning_of_drug_record) & !is.na(visit_occurrence_id),.(total=.N), by="year"][!is.na(year)]
    
    Res.dates.m[[w]]<-dates_count.m(dt=df, var_name = "meaning_of_drug_record", date_var2 = "date_prescription", date_var1 ="date_dispensing")
    Res.dates.my[[w]]<-dates_count.my(dt=df, var_name = "meaning_of_drug_record", date_var2  = "date_prescription", date_var1 ="date_dispensing")
    w<-w+1
    rm(df)
  }
  
  #  #save results for duplicates
  # dup_files<-list.files(tmp, pattern="^dup")
  # if (length(dup_files)>1){
  # dup<-fread(paste0(tmp,dup_files[1]), sep=";")
  # i<-2
  # for (i in 2:length(dup_files)){
  #   dup<-rbind(dup,fread(paste0(tmp,dup_files[i]), sep=";"))
  #   dup<-dup[duplicated(combination)]
  # }
  # dup<-dup[,.N]
  # } else {
  #   dup<-fread(paste0(tmp,dup_files), sep=";")
  #   dup<-dup[duplicated(combination)]
  #   dup<-dup[,.N]
  # }
  # rm(dup_files)
  
  Res.convention<-do.call(rbind, Res.convention)
  
 #Results for person_id
  #load all person id files
  persons_files<-list.files(tmp, pattern="^persons", full.names = T)
  #get size of each file
  size_persons<-lapply(persons_files, function(x) file.size(x))
  size_persons<-do.call(rbind,size_persons)
  size_persons<-data.table(file=persons_files, size_persons)
  setnames(size_persons, names(size_persons)[2], "size")
  size_persons[,size:=as.numeric(size)]
  #order files by size
  size_persons<-size_persons[order(size)]
  #get number of persons files
  length_persons_files<-size_persons[,.N]

  #stratified by meaning
  if (length(persons_files)>1){
  Res.p.c<-fread(size_persons[length_persons_files,file])
  Res.p.c[, comb:=paste(person_id, meaning_of_drug_record, sep="_^_")][!duplicated(comb)]
  for (i in 1:(length_persons_files-1)){
    a<-fread(size_persons[i,file])
    a<-a[, comb:=paste(person_id, meaning_of_drug_record, sep="_^_")][!duplicated(comb)]
    Res.p.c<-rbind(Res.p.c,a)
    Res.p.c<-Res.p.c[!duplicated(comb)]
    rm(a)
  }
  
  Res.p.c[,comb:=NULL]
  Res.p.c<-data.table(variable_name="person_id",Res.p.c[!is.na(meaning_of_drug_record), .(count=.N), by="meaning_of_drug_record"])
  names(Res.p.c)<-c("variable_name", "meaning", "count")
  Res.p.t<-do.call(rbind, Res.p.t)
  Res.p.t<-sum(Res.p.t)
   
  #stratified by meaning and year
  Res.p.c.y<-fread(size_persons[length_persons_files,file])
  Res.p.c.y[, comb_y := Reduce(function(...) paste(..., sep = "_^_"), .SD[, c("person_id", "year", "meaning_of_drug_record")])][!duplicated(comb_y)]
  for (i in 1:(length_persons_files-1)){
    a<-fread(size_persons[i,file])
    a<-a[, comb_y := Reduce(function(...) paste(..., sep = "_^_"), .SD[, c("person_id", "year", "meaning_of_drug_record")])][!duplicated(comb_y)]
    Res.p.c.y<-rbind(Res.p.c.y,a)
    Res.p.c.y<-Res.p.c.y[!duplicated(comb_y)]
    rm(a)
  }
  
  Res.p.c.y[,comb_y:=NULL]
  Res.p.c.y<-cbind(variable_name="person_id", Res.p.c.y[!is.na(meaning_of_drug_record), .(count=.N), by=.(meaning_of_drug_record, year)])
  Res.p.c.y<-Res.p.c.y[!is.na(year)]
  Res.p.c.y[,year:=as.integer(year)]
  Res.p.t.y<-do.call(rbind, Res.p.t.y)
  names(Res.p.t.y)<-c("year", "total")
  Res.p.t.y<-Res.p.t.y[,lapply(.SD, sum), .SDcols=c("total"), by=.(year)]
  Res.p.t.y[,year:=as.integer(year)]
#Res.p.c, Res.p.t counts and total stratified by meaning: person_id
#Res.p.c.y, Res.p.t.y counts and total stratified by meaning and year: person_id

    
  Res.p<-data.table(Res.p.c, total=Res.p.t) #results stratified by meaning
  rm(Res.p.c, Res.p.t)
  Res.p.y<-merge(Res.p.c.y, Res.p.t.y, by= "year") #results stratified by meaning and year
  setnames(Res.p.y, "meaning_of_drug_record", "meaning")
  setcolorder(Res.p.y, c("variable_name", "meaning", "year", "count", "total"))
  rm(Res.p.c.y, Res.p.t.y)
  } 
  
  if(length(persons_files)==1){
  Res.p.c<-fread(persons_files)
  Res.p.c[, comb:=paste(person_id, meaning_of_drug_record, sep="_^_")][!duplicated(comb)]
  Res.p.c[,comb:=NULL]
  
  Res.p.c<-data.table(variable_name="person_id",Res.p.c[!is.na(meaning_of_drug_record), .(count=.N), by="meaning_of_drug_record"])
  names(Res.p.c)<-c("variable_name", "meaning", "count")
  Res.p.t<-do.call(rbind, Res.p.t)
  Res.p.t<-sum(Res.p.t)
   
  #stratified by meaning and year
  Res.p.c.y<-fread(persons_files)
  Res.p.c.y[, comb_y := Reduce(function(...) paste(..., sep = "_^_"), .SD[, c("person_id", "year", "meaning_of_drug_record")])][!duplicated(comb_y)]
  
  Res.p.c.y[,comb_y:=NULL]
        Res.p.c.y<-cbind(variable_name="person_id", Res.p.c.y[!is.na(meaning_of_drug_record), .(count=.N), by=.(meaning_of_drug_record, year)])
  Res.p.c.y<-Res.p.c.y[!is.na(year)]
Res.p.c.y[,year:=as.integer(year)]
  Res.p.t.y<-do.call(rbind, Res.p.t.y)
  names(Res.p.t.y)<-c("year", "total")
  Res.p.t.y<-Res.p.t.y[,lapply(.SD, sum), .SDcols=c("total"), by=.(year)]
  Res.p.t.y[,year:=as.integer(year)]
#Res.p.c, Res.p.t counts and total stratified by meaning: person_id
#Res.p.c.y, Res.p.t.y counts and total stratified by meaning and year: person_id

    
  Res.p<-data.table(Res.p.c, total=Res.p.t) #results stratified by meaning
  rm(Res.p.c, Res.p.t)
  Res.p.y<-merge(Res.p.c.y, Res.p.t.y, by= "year") #results stratified by meaning and year
  setnames(Res.p.y, "meaning_of_drug_record", "meaning")
  setcolorder(Res.p.y, c("variable_name", "meaning", "year", "count", "total"))
  rm(Res.p.c.y, Res.p.t.y)
}
  #visit_occurrence_id  
  
  visits_files<-list.files(tmp, pattern="^visits", full.names = T)
    #get size of each file
  if (length(visits_files)>0){
  size_visits<-lapply(visits_files, function(x) file.size(x))
  size_visits<-do.call(rbind,size_visits)
  size_visits<-data.table(file=visits_files, size_visits)
  setnames(size_visits, names(size_visits)[2], "size")
  size_visits[,size:=as.numeric(size)]
  #order files by size
  size_visits<-size_visits[order(size)]
  #get number of persons files
  length_visits_files<-size_visits[,.N]
}
  
  #stratified by meaning
  if(length(visits_files)>1){
  Res.v.c<-fread(size_visits[length_visits_files,file])
  Res.v.c[, comb:=paste(visit_occurrence_id, meaning_of_drug_record, sep="_^_")][!duplicated(comb)]
  for (i in 1:(length_visits_files-1)){
    a<-fread(size_visits[i,file])
    a<-a[, comb:=paste(visit_occurrence_id, meaning_of_drug_record, sep="_^_")][!duplicated(comb)]
    Res.v.c<-rbind(Res.v.c,a)
    Res.v.c<-Res.v.c[!duplicated(comb)]
    rm(a)
  }
  Res.v.c[,comb:=NULL]
  Res.v.c<-data.table(variable_name="visit_occurrence_id",Res.v.c[!is.na(meaning_of_drug_record), .(count=.N), by="meaning_of_drug_record"])
  names(Res.v.c)<-c("variable_name", "meaning", "count")
  Res.v.t<-do.call(rbind, Res.v.t)
  Res.v.t<-sum(Res.v.t)
  
  #stratified by meaning and year
  Res.v.c.y<-fread(size_visits[length_visits_files,file])[!is.na(year)]
  Res.v.c.y[, comb_y := Reduce(function(...) paste(..., sep = "_^_"), .SD[, c("visit_occurrence_id", "year", "meaning_of_drug_record")])][!duplicated(comb_y)]
  for (i in 1:(length_visits_files-1)){
    a<-fread(size_visits[i,file])
    a<-a[!is.na(year)][, comb_y := Reduce(function(...) paste(..., sep = "_^_"), .SD[, c("visit_occurrence_id", "year", "meaning_of_drug_record")])][!duplicated(comb_y)]
    Res.v.c.y<-rbind(Res.v.c.y,a)
    Res.v.c.y<-Res.v.c.y[!duplicated(comb_y)]
    rm(a)
  }
  Res.v.c.y[,comb_y:=NULL]
  Res.v.c.y<-cbind(variable_name="visit_occurrence_id", Res.v.c.y[!is.na(meaning_of_drug_record), .(count=.N), by=.(meaning_of_drug_record, year)])
Res.v.c.y[,year:=as.integer(year)]
  Res.v.t.y<-do.call(rbind, Res.v.t.y)
  names(Res.v.t.y)<-c("year", "total")
  Res.v.t.y<-Res.v.t.y[,lapply(.SD, sum), .SDcols=c("total"), by=.(year)]
  Res.v.t.y[,year:=as.integer(year)]
#Res.v.c, Res.v.t counts and total stratified by meaning: person_id
#Res.v.c.y, Res.v.t.y counts and total stratified by meaning and year: visit_occurrence_id

    
  Res.v<-data.table(Res.v.c, total=Res.v.t) #results stratified by meaning
  rm(Res.v.c, Res.v.t)
  Res.v.y<-merge(Res.v.c.y, Res.v.t.y, by= "year") #results stratified by meaning and year
  setnames(Res.v.y, "meaning_of_drug_record", "meaning")
  setcolorder(Res.v.y, c("variable_name", "meaning", "year", "count", "total"))
  rm(Res.v.c.y, Res.v.t.y)
      }
  
if (length(visits_files)==1) {
  Res.v.c<-fread(visits_files)
  Res.v.c[, comb:=paste(visit_occurrence_id, meaning_of_drug_record, sep="_^_")][!duplicated(comb)]
Res.v.c[,comb:=NULL]
    Res.v.c<-data.table(variable_name="visit_occurrence_id",Res.v.c[!is.na(meaning_of_drug_record), .(count=.N), by="meaning_of_drug_record"])
     names(Res.v.c)<-c("variable_name", "meaning", "count")
  Res.v.t<-do.call(rbind, Res.v.t)
  Res.v.t<-sum(Res.v.t)
  
  #stratified by meaning and year
  Res.v.c.y<-fread(visits_files)[!is.na(year)]
  Res.v.c.y[, comb_y := Reduce(function(...) paste(..., sep = "_^_"), .SD[, c("visit_occurrence_id", "year", "meaning_of_drug_record")])][!duplicated(comb_y)]
Res.v.c.y[,comb_y:=NULL]
  Res.v.c.y<-cbind(variable_name="visit_occurrence_id", Res.v.c.y[!is.na(meaning_of_drug_record), .(count=.N), by=.(meaning_of_drug_record, year)])
Res.v.c.y[,year:=as.integer(year)]
  Res.v.t.y<-do.call(rbind, Res.v.t.y)
  names(Res.v.t.y)<-c("year", "total")
  Res.v.t.y<-Res.v.t.y[,lapply(.SD, sum), .SDcols=c("total"), by=.(year)]
  Res.v.t.y[,year:=as.integer(year)]
#Res.v.c, Res.v.t counts and total stratified by meaning: person_id
#Res.v.c.y, Res.v.t.y counts and total stratified by meaning and year: visit_occurrence_id

    
  Res.v<-data.table(Res.v.c, total=Res.v.t) #results stratified by meaning
  rm(Res.v.c, Res.v.t)
  Res.v.y<-merge(Res.v.c.y, Res.v.t.y, by= "year") #results stratified by meaning and year
  setnames(Res.v.y, "meaning_of_drug_record", "meaning")
  setcolorder(Res.v.y, c("variable_name", "meaning", "year", "count", "total"))
  rm(Res.v.c.y, Res.v.t.y)
      }  
  
if(length(visits_files)==0) {
  Res.v<-NULL
  Res.v.y<-NULL
}

 
   #Save results for distributions
  dist.disp_files<-list.files(tmp, pattern="^dist.disp")
   if (length(dist.disp_files)>1){
     dist.disp<-fread(paste0(tmp,dist.disp_files[1]))
  i<-2
  for (i in 2:length(dist.disp_files)){
    dist.disp<-rbind(dist.disp,fread(paste0(tmp,dist.disp_files[i])))
  }
  dist.disp[,year:=substr(date_dispensing, 1, 4)]
  tot_dist.disp<-dist.disp[,.N] #total number of obs with recorded meaning
  if(all(is.na(dist.disp[["date_dispensing"]]))==FALSE){
  tot_dist.disp.y<-dist.disp[!is.na(year), .N, by="year"]#total number of obs with recorded meaning i a particular year
    setnames(tot_dist.disp.y, "N", "total")
  } else {
    tot_dist.disp.y<-NULL}
   }
  
  if (length(dist.disp_files)==1){
     dist.disp<-fread(paste0(tmp,dist.disp_files))
    dist.disp[,year:=substr(date_dispensing, 1, 4)]
    tot_dist.disp<-dist.disp[,.N] #total number of obs with recorded meaning
    if(all(is.na(dist.disp[["date_dispensing"]]))==FALSE){
    tot_dist.disp.y<-dist.disp[!is.na(year), .N, by="year"]#total number of obs with recorded meaning i a particular year
    setnames(tot_dist.disp.y, "N", "total")
    }else {tot_dist.disp.y<-NULL}
  }
if (length(dist.disp_files)==0){
  dist.disp<-NULL
   tot_dist.disp<-NULL
   tot_dist.disp.y<-NULL
  }
  rm(dist.disp_files)

  #disp_number_medicinal_product by meaning
     if(!is.null(dist.disp)){
suppressWarnings(dist.disp<-dist.disp[,disp_number_medicinal_product:= as.numeric(disp_number_medicinal_product)])  #Transform the disp_number_medicinal_product into numeric from character
#Check if transformation went well, if not the distribution can not be shown
if(dist.disp[is.na(disp_number_medicinal_product),.N]>0){
dist.disp.m<-paste0("The variable disp_number_medicinal_product contains", dist.disp[is.na(disp_number_medicinal_product),.N], "non-numeric value(s) and as a result the distribution of this variable cannot be estimated.")
} else {
  #Save results for distributions
     #Dist of disp_number_medicinal_product
dist.disp.m<-cbind(table_name="MEDICINES", variable_name="disp_number_medicinal_product",distribution_meaning(dist.disp, "disp_number_medicinal_product"), total_records=tot_dist.disp)
}
       } else {dist.disp.m<-NULL}
     
#disp_number_medicinal_product by meaning and year
     if(!is.null(tot_dist.disp.y)){
     #Dist of disp_number_medicinal_product
dist.disp.y<-cbind(table_name="MEDICINES", variable_name="disp_number_medicinal_product",distribution_meaning_year(dist.disp[!is.na(year)], "disp_number_medicinal_product"))
dist.disp.y<-merge(dist.disp.y, tot_dist.disp.y, by="year")
setcolorder(dist.disp.y, c("table_name", "variable_name", "meaning", "year", "mean", "SD", "median", "IQR", "skewness", "kurtosis", "total"))
setnames(dist.disp.y, "total", "total_records")
} else {dist.disp.y<-NULL}
rm(dist.disp, tot_dist.disp, tot_dist.disp.y)       
  

   dist.pres_files<-list.files(tmp, pattern="^dist.pres")
   if (length(dist.pres_files)>1){
     dist.pres<-fread(paste0(tmp,dist.pres_files[1]))
  i<-2
  for (i in 2:length(dist.pres_files)){
    dist.pres<-rbind(dist.pres,fread(paste0(tmp,dist.pres_files[i])))
  }
  dist.pres[,year:=substr(date_prescription, 1, 4)]
  tot_dist.pres<-dist.pres[,.N] #total number of obs with recorded meaning
  if(all(is.na(dist.pres[["date_prescription"]]))==FALSE){
  tot_dist.pres.y<-dist.pres[!is.na(year), .N, by="year"]#total number of obs with recorded meaning i a particular year
    setnames(tot_dist.pres.y, "N", "total")
  } else {
    tot_dist.pres.y<-NULL}
   }
  
  if (length(dist.pres_files)==1){
     dist.pres<-fread(paste0(tmp,dist.pres_files))
    dist.pres[,year:=substr(date_prescription, 1, 4)]
    tot_dist.pres<-dist.pres[,.N] #total number of obs with recorded meaning
    if(all(is.na(dist.pres[["date_prescription"]]))==FALSE){
    tot_dist.pres.y<-dist.pres[!is.na(year), .N, by="year"]#total number of obs with recorded meaning i a particular year
    setnames(tot_dist.pres.y, "N", "total")
    }else {tot_dist.pres.y<-NULL}
  }
if (length(dist.pres_files)==0){
  dist.pres<-NULL
   tot_dist.pres<-NULL
   tot_dist.pres.y<-NULL
  }
  rm(dist.pres_files)
  
  #presc_quantity_per_day by meaning and unit
     if(!is.null(dist.pres)){
suppressWarnings(dist.pres<-dist.pres[,presc_quantity_per_day:= as.numeric(presc_quantity_per_day)])  #Transform the presc_quantity_per_day into numeric from character
#Check if transformation went well, if not the distribution can not be shown
if(dist.pres[is.na(presc_quantity_per_day),.N]>0){
dist.pres.m<-paste0("The variable presc_quantity_per_day contains", dist.pres[is.na(presc_quantity_per_day),.N], "non-numeric value(s) and as a result the distribution of this variable cannot be estimated.")
} else {
  dist.pres.m<-cbind(table_name="MEDICINES", variable_name="presc_quantity_per_day",distribution_meaning_unit(dist.pres, "presc_quantity_per_day"), total_records=tot_dist.pres)
} 
} else {dist.pres.m<-NULL}
       
 #presc_quantity_per_day by meaning, unit, year 
     if(!is.null(tot_dist.pres.y)){
     #Dist of presc_quantity_per_day
dist.pres.y<-cbind(table_name="MEDICINES", variable_name="presc_quantity_per_day",distribution_meaning_unit_year(dist.pres[!is.na(year)], "presc_quantity_per_day"))
dist.pres.y<-merge(dist.pres.y, tot_dist.pres.y, by="year")
setnames(dist.pres.y, "total", "total_records")
setcolorder(dist.pres.y, c("table_name", "variable_name", "meaning", "unit", "year", "mean", "SD", "median", "IQR", "skewness", "kurtosis", "total_records"))

} else {dist.pres.y<-NULL}
rm(dist.pres, tot_dist.pres, tot_dist.pres.y)
  
  
  dist.dur_files<-list.files(tmp, pattern="^dist.dur")
   if (length(dist.dur_files)>1){
     dist.dur<-fread(paste0(tmp,dist.dur_files[1]))
  i<-2
  for (i in 2:length(dist.dur_files)){
    dist.dur<-rbind(dist.dur,fread(paste0(tmp,dist.dur_files[i])))
  }
  dist.dur[,year:=substr(date_prescription, 1, 4)]
  tot_dist.dur<-dist.dur[,.N] #total number of obs with recorded meaning
  if(all(is.na(dist.dur[["date_prescription"]]))==FALSE){
  tot_dist.dur.y<-dist.dur[!is.na(year), .N, by="year"]#total number of obs with recorded meaning i a particular year
    setnames(tot_dist.dur.y, "N", "total")
  } else {tot_dist.dur.y<-NULL}
   }
  
  if (length(dist.dur_files)==1){
     dist.dur<-fread(paste0(tmp,dist.dur_files))
    dist.dur[,year:=substr(date_prescription, 1, 4)]
    tot_dist.dur<-dist.dur[,.N] #total number of obs with recorded meaning
    if(all(is.na(dist.dur[["date_prescription"]]))==FALSE){
    tot_dist.dur.y<-dist.dur[!is.na(year), .N, by="year"]#total number of obs with recorded meaning i a particular year
    setnames(tot_dist.dur.y, "N", "total")
    }else {tot_dist.dur.y<-NULL}
  }
if (length(dist.dur_files)==0){
  dist.dur<-NULL
   tot_dist.dur<-NULL
   tot_dist.dur.y<-NULL
  }
  rm(dist.dur_files)

#presc_duration_days by meaning
     if(!is.null(dist.dur)){
suppressWarnings(dist.dur<-dist.dur[,presc_duration_days:= as.numeric(presc_duration_days)])  #Transform the presc_duration_days into numeric from character
#Check if transformation went well, if not the distribution can not be shown
if(dist.dur[is.na(presc_duration_days),.N]>0){
dist.dur.m<-paste0("The variable presc_duration_days contains", dist.dur[is.na(presc_duration_days),.N], "non-numeric value(s) and as a result the distribution of this variable cannot be estimated.")
} else {
  #Save results for distributions
     #Dist of presc_duration_days
dist.dur.m<-cbind(table_name="MEDICINES", variable_name="presc_duration_days",distribution_meaning(dist.dur, "presc_duration_days"), total_records=tot_dist.dur)
}
     } else {dist.dur.m<-NULL}
       
#presc_duration_days by meaning and year
     if(!is.null(tot_dist.dur.y)){
     #Dist of presc_duration_days
dist.dur.y<-cbind(table_name="MEDICINES", variable_name="presc_duration_days",distribution_meaning_year(dist.dur[!is.na(year)], "presc_duration_days"))
dist.dur.y<-merge(dist.dur.y, tot_dist.dur.y, by="year")
setcolorder(dist.dur.y, c("table_name", "variable_name", "meaning", "year", "mean", "SD", "median", "IQR", "skewness", "kurtosis", "total"))
setnames(dist.dur.y, "total", "total_records")
} else {dist.dur.y<-NULL}
rm(dist.dur, tot_dist.dur, tot_dist.dur.y) 
i<-1
  #Combine results for counts by meaning(other variables)
  Res.4.1.c<-vector(mode="list", length=length(Res.4.1))
  Res.4.1.t<-vector(mode="list", length=length(Res.4.1))
  for (i in 1:length(Res.4.1)){
    Res.4.1.c[[i]]<-do.call(rbind, Res.4.1[[i]][1])
    Res.4.1.t[[i]]<-do.call(rbind, Res.4.1[[i]][2])
  }
  Res.4.1.c<-do.call(rbind, Res.4.1.c)
  Res.4.1.t<-do.call(rbind, Res.4.1.t)
  Res.4.1<-combine_counts1.m(Res.4.1.c, Res.4.1.t)
   if (!is.null(Res.v)){
   setnames(Res.p, "variable_name", "variable")
 setnames(Res.v, "variable_name", "variable")
 Res.4.1<-rbind(Res.4.1, Res.p, Res.v)
 } else {
    setnames(Res.p, "variable_name", "variable")
 Res.4.1<-rbind(Res.4.1, Res.p)
 }
  i<-1
  #Combine results for counts by meaning and year(other variables)
  Res.4.2.c<-vector(mode="list", length=length(Res.4.2))
  Res.4.2.t<-vector(mode="list", length=length(Res.4.2))
  for (i in 1:length(Res.4.2)){
    Res.4.2.c[[i]]<-do.call(rbind, Res.4.2[[i]][1])
    Res.4.2.t[[i]]<-do.call(rbind, Res.4.2[[i]][2])
  }
  Res.4.2.c<-do.call(rbind, Res.4.2.c)
  Res.4.2.t<-do.call(rbind, Res.4.2.t)
  Res.4.2<-combine_counts1.my(Res.4.2.c, Res.4.2.t)
     if (!is.null(Res.v.y)){
   setnames(Res.p.y, "variable_name", "variable")
 setnames(Res.v.y, "variable_name", "variable")
  Res.4.2<-rbind(Res.4.2, Res.p.y, Res.v.y)
  setnames(Res.4.2, "variable", "variable_name")
 } else {
  setnames(Res.p.y, "variable_name", "variable")
  Res.4.2<-rbind(Res.4.2, Res.p.y)
  setnames(Res.4.2, "variable", "variable_name")
 }
  i<-1
  #Combine counts by meaning(2 or more categories)
  Res.4.3.c<-vector(mode="list", length=length(Res.4.3))
  Res.4.3.t<-vector(mode="list", length=length(Res.4.3))
  for (i in 1:length(Res.4.3)){
    Res.4.3.c[[i]]<-do.call(rbind, Res.4.3[[i]][1])
    Res.4.3.t[[i]]<-do.call(rbind, Res.4.3[[i]][2])
  }
  Res.4.3.c<-do.call(rbind, Res.4.3.c)
  Res.4.3.t<-do.call(rbind, Res.4.3.t)
  Res.4.3<-combine_counts2.m(Res.4.3.c, Res.4.3.t)
  i<-1
  #Combine counts by meaning and year(2 or more categories)
  Res.4.4.c<-vector(mode="list", length=length(Res.4.4))
  Res.4.4.t<-vector(mode="list", length=length(Res.4.4))
  for (i in 1:length(Res.4.4)){
    Res.4.4.c[[i]]<-do.call(rbind, Res.4.4[[i]][1])
    Res.4.4.t[[i]]<-do.call(rbind, Res.4.4[[i]][2])
  }
  Res.4.4.c<-do.call(rbind, Res.4.4.c)
  Res.4.4.t<-do.call(rbind, Res.4.4.t)
  Res.4.4<-combine_counts2.my(Res.4.4.c, Res.4.4.t)
  i<-1
  #Combine counts for dates by meaning
  Res.dates.m.c<-vector(mode="list", length=length(Res.dates.m))
  Res.dates.m.t<-vector(mode="list", length=length(Res.dates.m))
  for (i in 1:length(Res.dates.m)){
    Res.dates.m.c[[i]]<-do.call(rbind, Res.dates.m[[i]][1])
    Res.dates.m.t[[i]]<-do.call(rbind, Res.dates.m[[i]][2])
  }
  Res.dates.m.c<-do.call(rbind, Res.dates.m.c)
  Res.dates.m.t<-do.call(rbind, Res.dates.m.t)
  Res.dates.m<-combine_counts1.m(Res.dates.m.c, Res.dates.m.t)
  i<-1
  #Combine counts for dates by meaning and year
  Res.dates.my.c<-vector(mode="list", length=length(Res.dates.my))
  Res.dates.my.t<-vector(mode="list", length=length(Res.dates.my))
  for (i in 1:length(Res.dates.my)){
    Res.dates.my.c[[i]]<-do.call(rbind, Res.dates.my[[i]][1])
    Res.dates.my.t[[i]]<-do.call(rbind, Res.dates.my[[i]][2])
  }
  Res.dates.my.c<-do.call(rbind, Res.dates.my.c)
  Res.dates.my.t<-do.call(rbind, Res.dates.my.t)
  Res.dates.my<-combine_counts1.my(Res.dates.my.c, Res.dates.my.t)
  
 Res.4.1<-Res.4.1[meaning !="NA"]
 Res.4.2<-Res.4.2[meaning !="NA"]
 Res.4.3<-Res.4.3[meaning !="NA"]
 Res.4.4<-Res.4.4[meaning !="NA"]
 Res.dates.m<-Res.dates.m[meaning !="NA"]
 Res.dates.my<-Res.dates.my[meaning !="NA"]
 
  output<-list("CONVENTION"= Res.convention, "COUNT1_M"=Res.4.1, "COUNT1_MY"=Res.4.2, "COUNT2_M"=Res.4.3[vocabulary !="NA"], "COUNT2_MY"=Res.4.4[vocabulary !="NA"], "DATES.M"=Res.dates.m, "DATES_MY"=Res.dates.my, "DIST.DISP.M"=dist.disp.m, "DIST.DISP.Y"=dist.disp.y, "DIST.PRES.M"=dist.pres.m, "DIST.PRES.Y"=dist.pres.y, "DIST.DUR.M"=dist.dur.m, "DIST.DUR.Y"=dist.dur.y)
  return(output)
}
```

```{r run_script, echo=FALSE, warning=FALSE}
Results.medicines<-step_4_5_check(actual_tables)
```

```{r include=FALSE}
unlink(paste0(medicines_dir, "tmp"), recursive = T)
```

<br>

<div class = 'box1'>
General information  
<br> 

Conventions:  
**1.** Each record must contain either a `date_dispensing` or a `date_prescription` value.     

</div>

<br>

<div class = 'box2'>

Duplicated rows:

```{r duplicated_rows, echo=FALSE}
# dup<-Results.medicines$DUP
# 
# if(dup>0){
#   print(paste0("There are ", dup, " duplicated rows in the data. Take caution when interpreting counts."))
# } else {
#   print("There are no duplicated rows in the data.")
# }
print("Due to the size of the files this check can not be performed.")
```

## 1. Convention check

Check if conventions are satisfied.

```{r results_convention, echo=FALSE, warning=FALSE}
#Output for convention check
Res.convention<-Results.medicines$CONVENTION

if (nrow(Res.convention[error==TRUE])==0){
  print("All conventions are satisfied.")
} else {
  datatable(Res.convention[error==TRUE], option=list(scrollX=TRUE))
}

```

</div>

<br>

<div class = 'box3'>

## 2. Counts of categorical variables

<br>

Counts will be divided based on the number of categories:     
 
2 or more categories:     
**a.** presc_quantity_unit    
**b** indication_code_vocabulary    
**c.** meaning_of_drug_record    
**d.** origin_of_drug_record     
**e.** prescriber_speciality_vocabulary      

Other variables:    
**a.** person_id    
**b** medicinal_product_id    
**c.** medicinal_product_atc_code    
**d.** disp_number_medicinal_product    
**e.** presc_quantity_per_day    
**f.** presc_duration_days   
**g.** product_lot_number   
**h.** indication_code  
**i.** prescriber_speciality   
**j.** visit_occurrence_id  
  
 
<br>

#### **Counts stratified by meaning (2 or more categories)** 

```{r count2_m, echo=FALSE, warning=FALSE}
Res.count2.m<-data.table(table_name="MEDICINES", Results.medicines$COUNT2_M)
setnames(Res.count2.m, "variable", "variable_name")
#Remove empty vocabulary values
Res.count2.m<-Res.count2.m[!(is.na(vocabulary))]
Res.count2.m<-Res.count2.m[vocabulary!=""]
Res.count2.m<-Res.count2.m[!(is.na(meaning))]
Res.count2.m<-Res.count2.m[meaning!=""]
if (nrow(Res.count2.m[(count ==0 & total ==0)])>0) {
  print(paste("There is(are)", nrow(Res.count2.m[(count ==0 & total ==0)]), "row(s) with a zero value for both count and total. Those will not be displayed in the tables or graphs. This happens when a variable is completely missing for a particular meaning category."))
}
#Remove rows where both count and total are zero
Res.count2.m<-Res.count2.m[(count !=0 & total !=0)]
#Calculate percentage
Res.count2.m[, percentage:=round((count/total)*100, digits=1)]

#If count>0 and percentage=0, replace percentage with rounded to the 5 level
Res.count2.m[as.numeric(count) > 0 & as.numeric(percentage) == 0, percentage := round((count/total)*100, digits=6)]

#Save results as .csv file
write.csv(Res.count2.m, paste(medicines_dir,"medicines_meaning_2categories.csv",sep="") ,row.names = F)

#Replace counts less than 5 with "<5" and percentage with "N/A"
Res.count2.m[, count:= as.character(count)][as.numeric(count) > 0 & as.numeric(count) < 5, count := "<5"]
Res.count2.m[, percentage:= as.character(percentage)][count == "<5", percentage := "N/A"]
Res.count2.m[, total:= as.character(total)][as.numeric(total) > 0 & as.numeric(total) < 5, total := "<5"] #replace total as well if lower than 5

#Put <5 counts in another dataset so the formatting can work
Res.count2.m.1<-Res.count2.m[count != "<5"]
Res.count2.m.1[, count:= as.numeric(count)]
Res.count2.m.1[, percentage:= as.numeric(percentage)]

if (Res.count2.m[,.N] != 0){
datatable(Res.count2.m, option=list(scrollX=TRUE)) %>% formatStyle("percentage",
  background = styleColorBar(range(0:100), "#76b82a"),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center')
}
#Save results as .csv file
write.csv(Res.count2.m, paste(medicines_less,"medicines_meaning_2categories_masked.csv",sep="") ,row.names = F)
```

```{r graph_count2_m, echo=FALSE, warning=FALSE}
if (Res.count2.m.1[,.N] != 0){
fig2.m<-vector(mode="list", length=length(unique(Res.count2.m.1[["variable_name"]])))
for(i in 1:length(unique(Res.count2.m.1[["variable_name"]]))){
  fig2.m[[i]]<-ggplotly(ggplot(Res.count2.m.1[variable_name==unique(Res.count2.m.1[["variable_name"]])[i]],
                               aes(x = meaning, y = percentage, fill=vocabulary)) +
                               geom_bar(position="dodge", stat="identity") +
                              theme_classic() +
                               ggtitle(unique(Res.count2.m.1[["variable_name"]])[i]) + 
                               xlab("Meaning") +
                               ylab("Percentage")+
                          ylim(0,100) +
                               theme(axis.text.x = element_text(angle = 45),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a")))
}
}
```

```{r display_graph_count2_m, echo=FALSE}
if (Res.count2.m.1[,.N] != 0){
htmltools::tagList(list(fig2.m))
}
```

<br>

#### **Counts stratified by meaning (other variables)**

```{r count1_m, echo=FALSE, warning=FALSE}
Res.count1.m<-data.table(table_name="MEDICINES", Results.medicines$COUNT1_M)
setnames(Res.count1.m, "variable", "variable_name")
Res.count1.m<-Res.count1.m[(!(is.na(meaning)))]
Res.count1.m<-Res.count1.m[meaning != ""]
if (nrow(Res.count1.m[(count !=0 & total !=0)])>0) {
  print(paste("There is(are)", nrow(Res.count1.m[(count ==0 & total ==0)]), "row(s) with a zero value for both count and total. Those will not be displayed in the tables or graphs. This happens when a variable is completely missing for a particular meaning category."))
}
#Remove rows where both count and total are zero
Res.count1.m<-Res.count1.m[(count !=0 & total !=0)]
Res.count1.m[, percentage:=round((count/total)*100, digits=1)]

#If count>0 and percentage=0, replace percentage with rounded to the 5 level
Res.count1.m[as.numeric(count) > 0 & as.numeric(percentage) == 0, percentage := round((count/total)*100, digits=6)]

#Save results as .csv file
write.csv(Res.count1.m, paste(medicines_dir,"medicines_meaning_other.csv",sep="") ,row.names = F)

#Replace counts less than 5 with "<5" and percentage with "N/A"
Res.count1.m[, count:= as.character(count)][as.numeric(count) > 0 & as.numeric(count) < 5, count := "<5"]
Res.count1.m[, total:= as.character(total)][as.numeric(total) > 0 & as.numeric(total) < 5, total := "<5"]
Res.count1.m[, percentage:= as.character(percentage)][count == "<5", percentage := "N/A"]

#Put <5 counts in another dataset so the formatting can work
Res.count1.m.1<-Res.count1.m[count != "<5"]
Res.count1.m.1[, count:= as.numeric(count)]
Res.count1.m.1[, percentage:= as.numeric(percentage)]

if (Res.count1.m[,.N] != 0){
datatable(Res.count1.m,  option=list(scrollX=TRUE)) %>% formatStyle("percentage",
  background = styleColorBar(range(0:100), "#76b82a"),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') 
}
#Save results as .csv file
write.csv(Res.count1.m, paste(medicines_less,"medicines_meaning_other_masked.csv",sep="") ,row.names = F)

```

```{r graph_count1_m, echo=FALSE, warning=FALSE}
if (Res.count1.m.1[,.N] != 0){
ggplotly(ggplot(Res.count1.m.1, aes(x = meaning, y = percentage)) +
                               geom_linerange(
                                 aes(x=meaning, ymin=0, ymax=percentage, group= variable_name),
                                 color="gray", size=1.5,
                                 position = position_dodge(0.6)) + 
                              geom_point(
                                aes(color=variable_name),
                                position=position_dodge(0.6), size=2
                              ) +
                              theme_classic() +
                               ggtitle("Counts stratified by meaning") + 
                               xlab("Meaning") +
                               ylab("Percentage")+
           ylim(0,100) +
                               theme(axis.text.x = element_text(angle = 45),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a")))
}
```
<br>

#### **Counts stratified by meaning and year (2 or more categories)**

If years before 1995 or years in the future are present, they will be colored red. 

```{r count2_my, echo=FALSE, warning=FALSE}
Res.count2.my<-data.table(table_name="MEDICINES", Results.medicines$COUNT2_MY)
setnames(Res.count2.my, "variable", "variable_name")
#Remove empty vocabulary values
Res.count2.my<-Res.count2.my[!(is.na(vocabulary))]
Res.count2.my<-Res.count2.my[vocabulary!=""]
Res.count2.my<-Res.count2.my[!(is.na(meaning))]
Res.count2.my<-Res.count2.my[meaning!=""]
Res.count2.my[,year:=as.numeric(year)]
if (nrow(Res.count2.my[(count ==0 & total ==0)])>0) {
  print(paste("There is(are)", nrow(Res.count2.my[(count ==0 & total ==0)]), "row(s) with a zero value for both count and total. Those will not be displayed in the tables or graphs. This happens when a variable is completely missing for a particular meaning category and year."))
}
#Remove rows where both count and total are 0
Res.count2.my<-Res.count2.my[(count !=0 & total !=0)]
#Calculate percentages
Res.count2.my[, percentage:=round((count/total)*100, digits=1)]

#If count>0 and percentage=0, replace percentage with rounded to the 5 level
Res.count2.my[as.numeric(count) > 0 & as.numeric(percentage) == 0, percentage := round((count/total)*100, digits=6)]

#Save results as .csv file
write.csv(Res.count2.my, paste(medicines_dir,"medicines_meaning_year_2categories.csv",sep=""),row.names = F)

#Replace counts less than 5 with "<5" and percentage with "N/A"
Res.count2.my[, count:= as.character(count)][as.numeric(count) > 0 & as.numeric(count) < 5, count := "<5"]
Res.count2.my[, percentage:= as.character(percentage)][count == "<5", percentage := "N/A"]
Res.count2.my[, total:= as.character(total)][as.numeric(total) > 0 & as.numeric(total) < 5, total := "<5"]

#Put <5 counts in another dataset for graphs
Res.count2.my.1<-Res.count2.my[count != "<5"]
Res.count2.my.1[, count:= as.numeric(count)]
Res.count2.my.1[, percentage:= as.numeric(percentage)]

if (Res.count2.my[,.N] != 0){
datatable(Res.count2.my, option=list(scrollX=TRUE)) %>% formatStyle("percentage",
  background = styleColorBar(range(0:100), "#76b82a"),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') %>% formatStyle(
  'year', 
  color = styleInterval(c(1995, as.numeric(substr(as.character(Sys.Date()), 1, 4))), c('red', 'black', 'red')),
  fontWeight = styleInterval(c(1995, as.numeric(substr(as.character(Sys.Date()), 1, 4))), c('bold', 'normal', 'bold'))
)
}
#Save results as .csv file
write.csv(Res.count2.my, paste(medicines_less,"medicines_meaning_year_2categories_masked.csv",sep=""),row.names = F)
```

If years in the future or before 1995 are present they will not be plotted in the graphs.   

```{r graph_count2_my, echo=FALSE, warning=FALSE}
if (Res.count2.my.1[,.N] != 0){
Res.count2.my.graph<-Res.count2.my.1[year<=as.numeric(substr(as.character(Sys.Date()), 1, 4)) & year>=1995]
Res.count2.my.graph[,year:=as.character(year)]

if(Res.count2.my.graph[,.N]>0){
fig.count2.my<-vector(mode="list", length=length(unique(Res.count2.my.graph[["variable_name"]])))
for(i in 1:length(unique(Res.count2.my.graph[["variable_name"]]))) {
  fig.count2.my[[i]]<-ggplotly(ggplot(Res.count2.my.graph[variable_name==unique(Res.count2.my.graph[["variable_name"]])[i]],aes(x = year, y = percentage, group=vocabulary)) +
                           geom_line(aes(color=vocabulary)) +
                           geom_point(aes(color=vocabulary)) + 
                            facet_wrap(~ meaning, ncol=2, scales = "fixed") +
                               ggtitle(unique(Res.count2.my.graph[["variable_name"]])[i]) + 
                               xlab("Year") +
                               ylab("Percentage")+
                             theme_classic() +
                             ylim(0,100) +
                             guides(shape = guide_legend(override.aes = list(size = 0.3))) +
                               theme(text=element_text(size=10),
                                 axis.text.x = element_text(angle = 90, hjust = 1),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a"),
                                     strip.text.y = element_text(angle = 0),
                                     legend.title = element_text(size = 7), 
               legend.text = element_text(size = 7))) 
                                     
}

#Move the x axis title down so it doesn't overlap with the labels
for (i in 1: length(fig.count2.my)){
fig.count2.my[[i]][['x']][['layout']][['annotations']][[1]][['y']] <--0.15
}
} else {
  fig.count2.my<-NULL
}
}
```


```{r display_graph_count2_my, echo=FALSE}
if (Res.count2.my.1[,.N] != 0){
  if (!is.null(fig.count2.my)){
htmltools::tagList(list(fig.count2.my))
}
}
```
<br>

#### **Counts stratified by meaning and year (other variables)**

If years before 1995 or years in the future are present, they will be colored red. 

```{r count1_my, echo=FALSE, warning=FALSE}
Res.count1.my<-data.table(table_name="MEDICINES", Results.medicines$COUNT1_MY)
Res.count1.my<-Res.count1.my[(!(is.na(meaning)))]
Res.count1.my<-Res.count1.my[meaning != ""]
Res.count1.my[,year:=as.numeric(year)]
if (nrow(Res.count1.my[(count ==0 & total ==0)])>0) {
  print(paste("There is(are)", nrow(Res.count1.my[(count ==0 & total ==0)]), "row(s) with a zero value for both count and total. Those will not be displayed in the tables or graphs. This happens when a variable is completely missing for a particular meaning category and year."))
}
#Remove rows where both count and total are 0
Res.count1.my<-Res.count1.my[(count !=0 & total !=0)]
Res.count1.my[, percentage:=round((count/total)*100, digits=1)]

#If count>0 and percentage=0, replace percentage with rounded to the 5 level
Res.count1.my[as.numeric(count) > 0 & as.numeric(percentage) == 0, percentage := round((count/total)*100, digits=6)]

#Save results as .csv file
write.csv(Res.count1.my, paste(medicines_dir,"medicines_meaning_year_other.csv",sep=""), row.names = F)

#Replace counts less than 5 with "<5" and percentage with "N/A"
Res.count1.my[, count:= as.character(count)][as.numeric(count) > 0 & as.numeric(count) < 5, count := "<5"]
Res.count1.my[, percentage:= as.character(percentage)][count == "<5", percentage := "N/A"]
Res.count1.my[, total:= as.character(total)][as.numeric(total) > 0 & as.numeric(total) < 5, total := "<5"]

#Put <5 counts in another dataset so the formatting can work
Res.count1.my.1<-Res.count1.my[count != "<5"]
Res.count1.my.1[, count:= as.numeric(count)]
Res.count1.my.1[, percentage:= as.numeric(percentage)]

if (Res.count1.my[,.N] != 0){
datatable(Res.count1.my, option=list(scrollX=TRUE)) %>% formatStyle("percentage",
  background = styleColorBar(range(0:100), "#76b82a"),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') %>% formatStyle(
  'year', 
  color = styleInterval(c(1995, as.numeric(substr(as.character(Sys.Date()), 1, 4))), c('red', 'black', 'red')),
  fontWeight = styleInterval(c(1995, as.numeric(substr(as.character(Sys.Date()), 1, 4))), c('bold', 'normal', 'bold'))
)
}

#Save results as .csv file
write.csv(Res.count1.my, paste(medicines_less,"medicines_meaning_year_other_masked.csv",sep=""), row.names = F)
```

If years in the future or before 1995 are present they will not be plotted in the graphs.   

```{r graph_count1_my, echo=FALSE, warning=FALSE}
if (Res.count1.my.1[,.N] != 0){
Res.count1.my.graph<-Res.count1.my.1[year<=as.numeric(substr(as.character(Sys.Date()), 1, 4)) & year>=1995]
Res.count1.my.graph[,year:=as.character(year)]
if(Res.count2.my.graph[,.N]>0){
fig1.my<-vector(mode="list", length=length(unique(Res.count1.my.graph[["variable_name"]])))
for(i in 1:length(unique(Res.count1.my.graph[["variable_name"]]))) {
  fig1.my[[i]]<-ggplotly(ggplot(Res.count1.my.graph[variable_name==unique(Res.count1.my.graph[["variable_name"]])[i]],aes(x = year, y = percentage, group=meaning)) +
                           geom_line(aes(color=meaning)) +
                           geom_point(aes(color=meaning)) +
                               ggtitle(unique(Res.count1.my.graph[["variable_name"]])[i]) + 
                               xlab("Year") +
                               ylab("Percentage")+
                           theme_classic() +
                           ylim(0,100) +
                               theme(axis.text.x = element_text(angle = 90, hjust=1),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a")))
}
} else {
  fig1.my<-NULL
}
}
```

```{r display_graph_count1_my, echo=FALSE}
if (Res.count1.my.1[,.N] != 0){
  if(!is.null(fig1.my)){
htmltools::tagList(list(fig1.my))
}
}
```

</div>

<br>

<div class = 'box4'>

## 3. Distribution of continous variables and counts of date variables

<br> 

### **Distribution of continuous variables**

The MEDICINES table contains 2 continuous variables:  
**a.** disp_number_medicinal_product    
**b.** presc_quantity_per_day     
**c.** presc_duration_days   

Distribution of continuous variables will be stratified by:   
**a.** disp_number_medicinal_product: meaning_of_drug_record and date_dispensing   
**b.** presc_quantity_per_day: meaning_of_drug_record, presc_quantity_unit and date_prescription   
**c.** presc_duration_days: meaning_of_drug_record and date_prescription  

If the number of observations with complete information on the variables of interest is less than 5, the distribution will not be shown.  
<br>

#### **Distribution of disp_number_medicinal_product stratified by meaning**

```{r dist_disp_m, echo=FALSE, warning=FALSE}
Res.dist.disp.meaning<-Results.medicines$DIST.DISP.M
if(!is.null(Res.dist.disp.meaning) & !is.character(Res.dist.disp.meaning)){
#output for distribution by meaning
Res.dist.disp.meaning<-data.table(Res.dist.disp.meaning[,1:3], 
                             Res.dist.disp.meaning[, lapply(.SD, FUN= function(x) round(x, 2)), .SDcols=c('mean', 'SD', 'median', 'IQR', 'skewness', 'kurtosis', 'total_records')])
#Remove missing variables(meaning==NA)

if (Res.dist.disp.meaning[total_records<5, .N]>0){
  comment_Res.dist.m<-"The distribution of disp_number_medicinal_product for one or more meaning categories cannot be displayed since the number of records with complete information in disp_number_medicinal_product and meaning_of_drug_record is smaller than 5."
Res.dist.disp.meaning_masked<-Res.dist.disp.meaning[total_records>5]

if (Res.dist.disp.meaning_masked[,.N]>0){
  print(comment_Res.dist.m)
  datatable(Res.dist.disp.meaning_masked, options = list(scrollX=T))
  } else {
print("The distribution of disp_number_medicinal_product cannot be displayed since the number of records with complete information in disp_number_medicinal_product and meaning_of_drug_record is smaller than 5.")
  }

} else {
  datatable(Res.dist.disp.meaning, options = list(scrollX=T))}
}



if (is.null(Res.dist.disp.meaning)){
  print("The distribution of disp_number_medicinal_product cannot be displayed due to complete missingness of one of the variables: disp_number_medicinal_product or meaning_of_drug_record.")
} 
if (is.character(Res.dist.disp.meaning)){
  print(Res.dist.disp.meaning)
}


#Save results as .csv file
if(!(is.null(Res.dist.disp.meaning)) & !is.character(Res.dist.disp.meaning)){
write.csv(Res.dist.disp.meaning, paste(medicines_dir,"medicines_meaning_dist_disp_num.csv",sep="") ,row.names = F)
}

#Save results as .csv file
if(!(is.null(Res.dist.disp.meaning)) & !is.character(Res.dist.disp.meaning)){
if (Res.dist.disp.meaning[total_records<5, .N]==0){
write.csv(Res.dist.disp.meaning, paste(medicines_less,"medicines_meaning_dist_disp_num_masked.csv",sep="") ,row.names = F)
} 
}

if(!(is.null(Res.dist.disp.meaning)) & !is.character(Res.dist.disp.meaning)){
  if (Res.dist.disp.meaning[total_records<5, .N]>0){
    if(Res.dist.disp.meaning_masked[,.N]>0){
write.csv(Res.dist.disp.meaning_masked, paste(medicines_less,"medicines_meaning_dist_disp_num_masked.csv",sep="") ,row.names = F)
  }
  }
}
```


```{r graph_dist_disp_m, echo=FALSE, warning=FALSE}
if(!is.null(Res.dist.disp.meaning) & !is.character(Res.dist.disp.meaning)){
if (Res.dist.disp.meaning[total_records<5, .N]==0){
ggplotly(ggplot(Res.dist.disp.meaning, aes(x = meaning, y = mean)) +
                               geom_linerange(
                                 aes(x=meaning, ymin=0, ymax=mean),
                                 color="gray", size=1.5,
                                 position = position_dodge(0.2)) + 
                              geom_point(
                                aes(color=meaning),
                                position=position_dodge(0.2), size=2
                              ) +
                              theme_classic() +
                               ggtitle("Distribution of disp_number_medicinal_product by meaning") + 
                               xlab("Meaning") +
                               ylab("Mean") +
                               theme(axis.text.x = element_text(angle = 45),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a")))



}
}
```

```{r graph_dist_disp_m_masked, echo=FALSE, warning=FALSE}
if(!is.null(Res.dist.disp.meaning) & !is.character(Res.dist.disp.meaning)){
if (Res.dist.disp.meaning[total_records<5, .N]>0){
  if (Res.dist.disp.meaning_masked[,.N]>0){
ggplotly(ggplot(Res.dist.disp.meaning_masked, aes(x = meaning, y = mean)) +
                               geom_linerange(
                                 aes(x=meaning, ymin=0, ymax=mean),
                                 color="gray", size=1.5,
                                 position = position_dodge(0.2)) + 
                              geom_point(
                                aes(color=meaning),
                                position=position_dodge(0.2), size=2
                              ) +
                              theme_classic() +
                               ggtitle("Distribution of disp_number_medicinal_product by meaning") + 
                               xlab("Meaning") +
                               ylab("Mean") +
                               theme(axis.text.x = element_text(angle = 45),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a")))



}
}
}
```

<br>

#### **Distribution of disp_number_medicinal_product stratified by meaning and year**

```{r dist_disp_my, echo=FALSE, warning=FALSE}
Res.dist.disp.my<-Results.medicines$DIST.DISP.Y
if(!is.null(Res.dist.disp.my) & !is.character(Res.dist.disp.my)){
#output for distribution by meaning and year
Res.dist.disp.my<-data.table(Res.dist.disp.my[,1:4], 
                             Res.dist.disp.my[, lapply(.SD, FUN= function(x) round(x, 2)), .SDcols=c('mean', 'SD', 'median', 'IQR', 'skewness', 'kurtosis', 'total_records')])

 if (Res.dist.disp.my[total_records<5, .N]>0){
  comment_Res.dist.my<-"The distribution of disp_number_medicinal_product for one or more meaning categories cannot be displayed since the number of records with complete information in disp_number_medicinal_product, date_dispensing, and meaning_of_drug_record is smaller than 5."
  Res.dist.disp.my_masked<-Res.dist.disp.my[total_records>5]

  if (Res.dist.disp.my_masked[,.N]>0){
    print(comment_Res.dist.my)
  datatable(Res.dist.disp.my_masked, options = list(scrollX=T))
  } else {
print("The distribution of disp_number_medicinal_product cannot be displayed since the number of records with complete information in disp_number_medicinal_product, date_dispensing, and meaning_of_drug_record is smaller than 5.")
  }

} else {
  datatable(Res.dist.disp.my, options = list(scrollX=T))}
}

if (is.null(Res.dist.disp.my)){
  print("The distribution of disp_number_medicinal_product cannot be displayed due to complete missingness of one of the variables: disp_number_medicinal_product, date_dispensing, or meaning_of_drug_record.")
}
if (is.character(Res.dist.disp.my)){
  print(Res.dist.disp.my)
}

#Save results as .csv file
if(!(is.null(Res.dist.disp.my)) & !is.character(Res.dist.disp.my)){
write.csv(Res.dist.disp.my, paste(medicines_dir,"medicines_meaning_year_dist_disp_num.csv",sep="") ,row.names = F)
}

if(!(is.null(Res.dist.disp.my)) & !is.character(Res.dist.disp.my)){
  if (Res.dist.disp.my[total_records<5, .N]==0){
write.csv(Res.dist.disp.my, paste(medicines_less,"medicines_meaning_year_dist_disp_num_masked.csv",sep="") ,row.names = F)
  }
}

if(!(is.null(Res.dist.disp.my)) & !is.character(Res.dist.disp.my)){
  if (Res.dist.disp.my[total_records<5, .N]>0){
    if(Res.dist.disp.my_masked[,.N]>0){
write.csv(Res.dist.disp.my_masked, paste(medicines_less,"medicines_meaning_year_dist_disp_num_masked.csv",sep="") ,row.names = F)
  }
  }
}
```

If years in the future or before 1995 are present they will not be plotted in the graphs.   

```{r graph_dist_disp_my, echo=FALSE, warning=FALSE}
if(!is.null(Res.dist.disp.my) & !is.character(Res.dist.disp.my)){
if (Res.dist.disp.my[total_records<5, .N]==0 & Res.dist.disp.my[year>1995, .N]>0){
ggplotly(ggplot(Res.dist.disp.my[year>1995 & year<=as.numeric(substr(as.character(Sys.Date()), 1, 4))][,year:=as.character(year)], aes(x = year, y = mean)) +
                               geom_linerange(
                                 aes(x=year, ymin=0, ymax=mean, group= meaning),
                                 color="gray", size=1.5,
                                 position = position_dodge(0.2)) + 
                              geom_point(
                                aes(color=meaning),
                                position=position_dodge(0.2), size=2
                              ) +
                              theme_classic() +
                               ggtitle("Distribution of disp_number_medicinal_product by meaning and year") + 
                               xlab("Year") +
                               ylab("Mean")+
                               theme(axis.text.x = element_text(angle = 45),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a")))

}
}
```

```{r graph_dist_disp_my_masked, echo=FALSE, warning=FALSE}
if(!is.null(Res.dist.disp.my) & !is.character(Res.dist.disp.my)){
if(Res.dist.disp.my[total_records<5, .N]>0){
if(Res.dist.disp.my_masked[,.N]>0 & Res.dist.disp.my_masked[year>1995, .N]>0){
ggplotly(ggplot(Res.dist.disp.my_masked[year>1995 & year<=as.numeric(substr(as.character(Sys.Date()), 1, 4))][,year:=as.character(year)], aes(x = year, y = mean)) +
                               geom_linerange(
                                 aes(x=year, ymin=0, ymax=mean, group= meaning),
                                 color="gray", size=1.5,
                                 position = position_dodge(0.2)) + 
                              geom_point(
                                aes(color=meaning),
                                position=position_dodge(0.2), size=2
                              ) +
                              theme_classic() +
                               ggtitle("Distribution of disp_number_medicinal_product by meaning and year") + 
                               xlab("Year") +
                               ylab("Mean")+
                               theme(axis.text.x = element_text(angle = 45),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a")))

}
}
}
```


<br>

#### **Distribution of presc_quantity_per_day stratified by meaning and unit**

```{r dist_presc_mu, echo=FALSE, warning=FALSE}
Res.dist.pres.mu<-Results.medicines$DIST.PRES.M

if(!is.null(Res.dist.pres.mu) & !is.character(Res.dist.pres.mu)){
#output for distribution by meaning and year
Res.dist.pres.mu<-data.table(Res.dist.pres.mu[,1:4], 
                             Res.dist.pres.mu[, lapply(.SD, FUN= function(x) round(x, 2)), .SDcols=c('mean', 'SD', 'median', 'IQR', 'skewness', 'kurtosis', 'total_records')])


if (Res.dist.pres.mu[total_records<5, .N]>0){
  comment_Res.dist.pres.mu<-"The distribution of presc_quantity_per_day for one or more meaning categories cannot be displayed since the number of records with complete information in presc_quantity_per_day and meaning_of_drug_record is smaller than 5."
Res.dist.pres.mu_masked<-Res.dist.pres.mu[total_records>5]

if (Res.dist.pres.mu_masked[,.N]>0){
  print(comment_Res.dist.pres.mu)
  datatable(Res.dist.pres.mu_masked, options = list(scrollX=T))
  } else {
print("The distribution of presc_quantity_per_day cannot be displayed since the number of records with complete information in presc_quantity_per_day and meaning_of_drug_record is smaller than 5.")
  }

} else {
  datatable(Res.dist.pres.mu, options = list(scrollX=T))}
}

if (is.null(Res.dist.pres.mu)){
  print("The distribution of presc_quantity_per_day cannot be displayed due to complete missingness of one of the variables: presc_quantity_per_day or meaning_of_drug_record.")
} 
if (is.character(Res.dist.pres.mu)){
  print(Res.dist.pres.mu)
}


#Save results as .csv file
if(!(is.null(Res.dist.pres.mu)) & !is.character(Res.dist.pres.mu)){
write.csv(Res.dist.pres.mu, paste(medicines_dir,"medicines_meaning_unit_dist_pres.csv",sep="") ,row.names = F)
}

#Save results as .csv file
if(!(is.null(Res.dist.pres.mu)) & !is.character(Res.dist.pres.mu)){
if (Res.dist.pres.mu[total_records<5, .N]==0){
write.csv(Res.dist.pres.mu, paste(medicines_less,"medicines_meaning_unit_dist_pres_masked.csv",sep="") ,row.names = F)
} 
}

if(!(is.null(Res.dist.pres.mu)) & !is.character(Res.dist.pres.mu)){
  if (Res.dist.pres.mu[total_records<5, .N]>0){
    if(Res.dist.pres.mu_masked[,.N]>0){
write.csv(Res.dist.pres.mu_masked, paste(medicines_less,"medicines_meaning_unit_dist_pres_masked.csv",sep="") ,row.names = F)
  }
  }
}
```

```{r graph_dist_presc_mu, echo=FALSE, warning=FALSE}
if(!is.null(Res.dist.pres.mu) & !is.character(Res.dist.pres.mu)){
if (Res.dist.pres.mu[total_records<5, .N]==0){
ggplotly(ggplot(Res.dist.pres.mu, aes(x = meaning, y = mean)) +
                               geom_linerange(
                                 aes(x=meaning, ymin=0, ymax=mean, group= unit),
                                 color="gray", size=1.5,
                                 position = position_dodge(0.2)) + 
                              geom_point(
                                aes(color=unit),
                                position=position_dodge(0.2), size=2
                              ) +
                              theme_classic() +
                               ggtitle("Distribution of presc_quantity_per_day by meaning and unit") + 
                               xlab("Meaning") +
                               ylab("Mean")+
                               theme(axis.text.x = element_text(angle = 45),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a")))

}
}
```

```{r graph_dist_presc_mu_masked, echo=FALSE, warning=FALSE}
if(!is.null(Res.dist.pres.mu) & !is.character(Res.dist.pres.mu)){
if (Res.dist.pres.mu[total_records<5, .N]>0){
    if (Res.dist.pres.mu_masked[,.N]>0){
ggplotly(ggplot(Res.dist.pres.mu_masked, aes(x = meaning, y = mean)) +
                               geom_linerange(
                                 aes(x=meaning, ymin=0, ymax=mean, group= unit),
                                 color="gray", size=1.5,
                                 position = position_dodge(0.2)) + 
                              geom_point(
                                aes(color=unit),
                                position=position_dodge(0.2), size=2
                              ) +
                              theme_classic() +
                               ggtitle("Distribution of presc_quantity_per_day by meaning and unit") + 
                               xlab("Meaning") +
                               ylab("Mean")+
                               theme(axis.text.x = element_text(angle = 45),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a")))

}
}
}
```

<br>

#### **Distribution of presc_quantity_per_day stratified by meaning, unit and year**

```{r dist_presc_muy, echo=FALSE, warning=FALSE}
Res.dist.pres.muy<-Results.medicines$DIST.PRES.Y
if(!is.null(Res.dist.pres.muy) & !is.character(Res.dist.pres.muy)){
#output for distribution by meaning and year
Res.dist.pres.muy<-data.table(Res.dist.pres.muy[,1:5], 
                             Res.dist.pres.mu[, lapply(.SD, FUN= function(x) round(x, 2)), .SDcols=c('mean', 'SD', 'median', 'IQR', 'skewness', 'kurtosis', 'total_records')])

if (Res.dist.pres.muy[total_records<5, .N]>0){
  comment_Res.dist.pres.muy<-"The distribution of presc_quantity_per_day for one or more meaning categories cannot be displayed since the number of records with complete information in presc_quantity_per_day, date_prescription, and meaning_of_drug_record is smaller than 5."
  Res.dist.pres.muy_masked<-Res.dist.pres.muy[total_records>5]

  if (Res.dist.pres.muy_masked[,.N]>0){
    print(comment_Res.dist.pres.muy)
  datatable(Res.dist.pres.muy_masked, options = list(scrollX=T))
  } else {
print("The distribution of presc_quantity_per_day cannot be displayed since the number of records with complete information in presc_quantity_per_day, date_prescription, and meaning_of_drug_record is smaller than 5.")
  }

} else {
  datatable(Res.dist.pres.muy, options = list(scrollX=T))}
}

if (is.null(Res.dist.pres.muy)){
  print("The distribution of presc_quantity_per_day cannot be displayed due to complete missingness of one of the variables: presc_quantity_per_day, date_prescription, or meaning_of_drug_record.")
}
if (is.character(Res.dist.pres.muy)){
  print(Res.dist.pres.muy)
}

#Save results as .csv file
if(!(is.null(Res.dist.pres.muy)) & !is.character(Res.dist.pres.muy)){
write.csv(Res.dist.pres.muy, paste(medicines_dir,"medicines_meaning_unit_year_dist_pres.csv",sep="") ,row.names = F)
}

if(!(is.null(Res.dist.pres.muy)) & !is.character(Res.dist.pres.muy)){
  if (Res.dist.pres.muy[total_records<5, .N]==0){
write.csv(Res.dist.pres.muy, paste(medicines_less,"medicines_meaning_unit_year_dist_pres_masked.csv",sep="") ,row.names = F)
  }
}

if(!(is.null(Res.dist.pres.muy)) & !is.character(Res.dist.pres.muy)){
  if (Res.dist.pres.muy[total_records<5, .N]>0){
    if(Res.dist.pres.muy_masked[,.N]>0){
write.csv(Res.dist.pres.muy_masked, paste(medicines_less,"medicines_meaning_unit_year_dist_pres_masked.csv",sep="") ,row.names = F)
  }
  }
}

```

If years in the future or before 1995 are present they will not be plotted in the graphs.   

```{r graph_dist_presc_muy, echo=FALSE, warning=FALSE}
if(!is.null(Res.dist.pres.muy) & !is.character(Res.dist.pres.muy)){
if (Res.dist.pres.muy[total_records<5, .N]==0 & Res.dist.pres.muy[year>1995, .N]>0){

Res.dist.pres.muy.graph<-Res.dist.pres.muy[year<=as.numeric(substr(as.character(Sys.Date()), 1, 4)) & year>=1995]
Res.dist.pres.muy.graph[,year:=as.character(year)]

fig.pres.muy<-vector(mode="list", length=length(unique(Res.dist.pres.muy.graph[["meaning"]])))
for(i in 1:length(unique(Res.dist.pres.muy.graph[["meaning"]]))) {
  fig.pres.muy[[i]]<-ggplotly(ggplot(Res.dist.pres.muy.graph[meaning==unique(Res.dist.pres.muy.graph[["meaning"]])[i]],aes(x = year, y = mean, group=unit)) +
                           geom_line(aes(color=unit)) +
                           geom_point(aes(color=unit)) +
                               ggtitle(unique(Res.dist.pres.muy.graph[["meaning"]])[i]) + 
                               xlab("Year") +
                               ylab("Mean")+
                             theme_classic() +
                             ylim(0,100) +
                               theme(axis.text.x = element_text(angle = 90, hjust=1),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a")))
}
}
}
```

```{r display_graph_dist_presc_muy, echo=FALSE}
if(!is.null(Res.dist.pres.muy) & !is.character(Res.dist.pres.muy)){
if (Res.dist.pres.muy[total_records<5, .N]==0 & Res.dist.pres.muy[year>1995, .N]>0){
htmltools::tagList(list(fig.pres.muy))
}
}
```

```{r graph_dist_presc_muy_masked, echo=FALSE, warning=FALSE}
if(!is.null(Res.dist.pres.muy) & !is.character(Res.dist.pres.muy)){
  if(Res.dist.pres.muy[total_records<5, .N]>0){
if (Res.dist.pres.muy_masked[total_records<5, .N]==0 & Res.dist.pres.muy_masked[year>1995, .N]>0){

Res.dist.pres.muy_masked.graph<-Res.dist.pres.muy_masked[year<=as.numeric(substr(as.character(Sys.Date()), 1, 4)) & year>=1995]
Res.dist.pres.muy_masked.graph[,year:=as.character(year)]

fig.pres.muy_masked<-vector(mode="list", length=length(unique(Res.dist.pres.muy_masked.graph[["meaning"]])))
for(i in 1:length(unique(Res.dist.pres.muy_masked.graph[["meaning"]]))) {
  fig.pres.muy_masked[[i]]<-ggplotly(ggplot(Res.dist.pres.muy_masked.graph[meaning==unique(Res.dist.pres.muy_masked.graph[["meaning"]])[i]],aes(x = year, y = mean, group=unit)) +
                           geom_line(aes(color=unit)) +
                           geom_point(aes(color=unit)) +
                               ggtitle(unique(Res.dist.pres.muy_masked.graph[["meaning"]])[i]) + 
                               xlab("Year") +
                               ylab("Mean")+
                             theme_classic() +
                             ylim(0,100) +
                               theme(axis.text.x = element_text(angle = 90, hjust=1),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a")))
}
}
  }
}
```

```{r display_graph_dist_presc_muy_masked, echo=FALSE}
if(!is.null(Res.dist.pres.muy) & !is.character(Res.dist.pres.muy)){
  if(Res.dist.pres.muy[total_records<5, .N]>0){
if (Res.dist.pres.muy_masked[total_records<5, .N]==0 & Res.dist.pres.muy_masked[year>1995, .N]>0){
htmltools::tagList(list(fig.pres.muy_masked))
}
  }
}
```

<br>

#### **Distribution of presc_duration_days stratified by meaning**

```{r dist_dur_m, echo=FALSE, warning=FALSE}
Res.dist.dur.m<-Results.medicines$DIST.DUR.M

if(!is.null(Res.dist.dur.m) & !is.character(Res.dist.dur.m)){
#output for distribution by meaning
Res.dist.dur.m<-data.table(Res.dist.dur.m[,1:3], 
                             Res.dist.dur.m[, lapply(.SD, FUN= function(x) round(x, 2)), .SDcols=c('mean', 'SD', 'median', 'IQR', 'skewness', 'kurtosis', 'total_records')])
#Remove missing variables(meaning==NA)


if (Res.dist.dur.m[total_records<5, .N]>0){
  comment_Res.dist.dur.m<-"The distribution of presc_duration_days for one or more meaning categories cannot be displayed since the number of records with complete information in presc_duration_days and meaning_of_drug_record is smaller than 5."
Res.dist.dur.m_masked<-Res.dist.dur.m[total_records>5]

if (Res.dist.dur.m_masked[,.N]>0){
  print(comment_Res.dist.dur.m)
  datatable(Res.dist.dur.m_masked, options = list(scrollX=T))
  } else {
print("The distribution of presc_duration_days cannot be displayed since the number of records with complete information in presc_duration_days and meaning_of_drug_record is smaller than 5.")
  }

} else {
  datatable(Res.dist.dur.m, options = list(scrollX=T))}
}

if (is.null(Res.dist.dur.m)){
  print("The distribution of presc_duration_days cannot be displayed due to complete missingness of one of the variables: presc_duration_days or meaning_of_drug_record.")
} 
if (is.character(Res.dist.dur.m)){
  print(Res.dist.dur.m)
}


#Save results as .csv file
if(!(is.null(Res.dist.dur.m)) & !is.character(Res.dist.dur.m)){
write.csv(Res.dist.dur.m, paste(medicines_dir,"medicines_meaning_dist_dur.csv",sep="") ,row.names = F)
}

#Save results as .csv file
if(!(is.null(Res.dist.dur.m)) & !is.character(Res.dist.dur.m)){
if (Res.dist.dur.m[total_records<5, .N]==0){
write.csv(Res.dist.dur.m, paste(medicines_less,"medicines_meaning_dist_dur_masked.csv",sep="") ,row.names = F)
} 
}

if(!(is.null(Res.dist.dur.m)) & !is.character(Res.dist.dur.m)){
  if (Res.dist.dur.m[total_records<5, .N]>0){
    if(Res.dist.dur.m_masked[,.N]>0){
write.csv(Res.dist.dur.m_masked, paste(medicines_less,"medicines_meaning_dist_dur_masked.csv",sep="") ,row.names = F)
  }
  }
}

```
<br>

```{r graph_dist_dur_m, echo=FALSE, warning=FALSE}
if(!is.null(Res.dist.dur.m) & !is.character(Res.dist.dur.m)){
if (Res.dist.dur.m[total_records<5, .N]==0){
ggplotly(ggplot(Res.dist.dur.m, aes(x = meaning, y = mean)) +
                               geom_linerange(
                                 aes(x=meaning, ymin=0, ymax=mean),
                                 color="gray", size=1.5,
                                 position = position_dodge(0.2)) + 
                              geom_point(
                                aes(color=meaning),
                                position=position_dodge(0.2), size=2
                              ) +
                              theme_classic() +
                               ggtitle("Distribution of presc_duration_days by meaning") + 
                               xlab("Meaning") +
                               ylab("Mean") +
                               theme(axis.text.x = element_text(angle = 45),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a")))



}
}
```

```{r graph_dist_dur_m_masked, echo=FALSE, warning=FALSE}
if(!is.null(Res.dist.dur.m) & !is.character(Res.dist.dur.m)){
if (Res.dist.dur.m[total_records<5, .N]>0){
    if (Res.dist.dur.m_masked[,.N]>0){
ggplotly(ggplot(Res.dist.dur.m_masked, aes(x = meaning, y = mean)) +
                               geom_linerange(
                                 aes(x=meaning, ymin=0, ymax=mean),
                                 color="gray", size=1.5,
                                 position = position_dodge(0.2)) + 
                              geom_point(
                                aes(color=meaning),
                                position=position_dodge(0.2), size=2
                              ) +
                              theme_classic() +
                               ggtitle("Distribution of presc_duration_days by meaning") + 
                               xlab("Meaning") +
                               ylab("Mean") +
                               theme(axis.text.x = element_text(angle = 45),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a")))



}
}
}
```

#### **Distribution of presc_duration_days stratified by meaning and year**

```{r dist_dur_my, echo=FALSE, warning=FALSE}
Res.dist.dur.my<-Results.medicines$DIST.DUR.Y

if(!is.null(Res.dist.dur.my) & !is.character(Res.dist.dur.my)){
#output for distribution by meaning and year
Res.dist.dur.my<-data.table(Res.dist.dur.my[,1:4], 
                             Res.dist.dur.my[, lapply(.SD, FUN= function(x) round(x, 2)), .SDcols=c('mean', 'SD', 'median', 'IQR', 'skewness', 'kurtosis', 'total_records')])


if (Res.dist.dur.my[total_records<5, .N]>0){
  comment_Res.dist.dur.my<-"The distribution of presc_duration_days for one or more meaning categories cannot be displayed since the number of records with complete information in presc_duration_days, date_prescription, and meaning_of_drug_record is smaller than 5."
  Res.dist.dur.my_masked<-Res.dist.dur.my[total_records>5]

  if (Res.dist.dur.my_masked[,.N]>0){
    print(comment_Res.dist.dur.my)
  datatable(Res.dist.dur.my_masked, options = list(scrollX=T))
  } else {
print("The distribution of presc_duration_days cannot be displayed since the number of records with complete information in presc_duration_days, date_prescription, and meaning_of_drug_record is smaller than 5.")
  }

} else {
  datatable(Res.dist.dur.my, options = list(scrollX=T))}
}

if (is.null(Res.dist.dur.my)){
  print("The distribution of presc_duration_days cannot be displayed due to complete missingness of one of the variables: presc_duration_days, date_prescription, or meaning_of_drug_record.")
}
if (is.character(Res.dist.dur.my)){
  print(Res.dist.dur.my)
}


#Save results as .csv file
if(!(is.null(Res.dist.dur.my)) & !is.character(Res.dist.dur.my)){
write.csv(Res.dist.dur.my, paste(medicines_dir,"medicines_meaning_year_dist_dur.csv",sep="") ,row.names = F)
}

if(!(is.null(Res.dist.dur.my)) & !is.character(Res.dist.dur.my)){
  if (Res.dist.dur.my[total_records<5, .N]==0){
write.csv(Res.dist.dur.my, paste(medicines_less,"medicines_meaning_year_dist_dur_masked.csv",sep="") ,row.names = F)
  }
}

if(!(is.null(Res.dist.dur.my)) & !is.character(Res.dist.dur.my)){
  if (Res.dist.dur.my[total_records<5, .N]>0){
    if(Res.dist.dur.my_masked[,.N]>0){
write.csv(Res.dist.dur.my_masked, paste(medicines_less,"medicines_meaning_year_dist_dur_masked.csv",sep="") ,row.names = F)
  }
  }
}
```

If years in the future or before 1995 are present they will not be plotted in the graphs.   

```{r graph_dist_dur_my, echo=FALSE, warning=FALSE}
if(!is.null(Res.dist.dur.my) & !is.character(Res.dist.dur.my)){
if (Res.dist.dur.my[total_records<5, .N]==0 & Res.dist.dur.my[year>1995, .N]>0){
ggplotly(ggplot(Res.dist.dur.my[year>1995 & year<=as.numeric(substr(as.character(Sys.Date()), 1, 4))][,year:=as.character(year)], aes(x = year, y = mean)) +
                               geom_linerange(
                                 aes(x=year, ymin=0, ymax=mean, group= meaning),
                                 color="gray", size=1.5,
                                 position = position_dodge(0.2)) + 
                              geom_point(
                                aes(color=meaning),
                                position=position_dodge(0.2), size=2
                              ) +
                              theme_classic() +
                               ggtitle("Distribution of presc_duration_days by meaning and year") + 
                               xlab("Year") +
                               ylab("Mean")+
                               theme(axis.text.x = element_text(angle = 45),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a")))

}
}
```

```{r graph_dist_dur_my_masked, echo=FALSE, warning=FALSE}
if(!is.null(Res.dist.dur.my) & !is.character(Res.dist.dur.my)){
    if(Res.dist.dur.my[total_records<5, .N]>0){
if (Res.dist.dur.my_masked[total_records<5, .N]==0 & Res.dist.dur.my_masked[year>1995, .N]>0){
ggplotly(ggplot(Res.dist.dur.my_masked[year>1995 & year<=as.numeric(substr(as.character(Sys.Date()), 1, 4))][,year:=as.character(year)], aes(x = year, y = mean)) +
                               geom_linerange(
                                 aes(x=year, ymin=0, ymax=mean, group= meaning),
                                 color="gray", size=1.5,
                                 position = position_dodge(0.2)) + 
                              geom_point(
                                aes(color=meaning),
                                position=position_dodge(0.2), size=2
                              ) +
                              theme_classic() +
                               ggtitle("Distribution of presc_duration_days by meaning and year") + 
                               xlab("Year") +
                               ylab("Mean")+
                               theme(axis.text.x = element_text(angle = 45),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a")))

}
    }
}
```

### **Counts of dates variables**

<br>

#### **Counts stratified by meaning**

```{r count.dates_m, echo=FALSE, warning=FALSE}
#Output for dates count by meaning
Res.dates.m<-data.table(table_name="MEDICINES", Results.medicines$DATES.M)
setnames(Res.dates.m, "variable", "variable_name")
Res.dates.m<-Res.dates.m[(!(is.na(meaning)))]
Res.dates.m<-Res.dates.m[meaning != ""]
if (nrow(Res.dates.m[(count ==0 & total ==0)])>0) {
  print(paste("There is(are)", nrow(Res.dates.m[(count ==0 & total ==0)]), "row(s) with a zero value for both count and total. Those will not be displayed in the tables or graphs. This happens when a variable is completely missing for a particular meaning category."))
}
#Remove rows where both count and total are 0
Res.dates.m<-Res.dates.m[(count !=0 & total !=0)]
Res.dates.m[, percentage:=round((count/total)*100, digits=1)]

#If count>0 and percentage=0, replace percentage with rounded to the 5 level
Res.dates.m[as.numeric(count) > 0 & as.numeric(percentage) == 0, percentage := round((count/total)*100, digits=6)]

#Save results as .csv file
write.csv(Res.dates.m, paste(medicines_dir,"medicines_meaning_dates.csv",sep=""), row.names = F)

#Replace counts less than 5 with "<5" and percentage with "N/A"
Res.dates.m[, count:= as.character(count)][as.numeric(count) > 0 & as.numeric(count) < 5, count := "<5"]
Res.dates.m[, percentage:= as.character(percentage)][count == "<5", percentage := "N/A"]
Res.dates.m[, total:= as.character(total)][as.numeric(total) > 0 & as.numeric(total) < 5, total := "<5"]

#Put <5 counts in another dataset so the formatting can work
Res.dates.m.1<-Res.dates.m[count != "<5"]
Res.dates.m.1[, count:= as.numeric(count)]
Res.dates.m.1[, percentage:= as.numeric(percentage)]

if (Res.dates.m[,.N] != 0){
datatable(Res.dates.m, option=list(scrollX=TRUE)) %>% formatStyle("percentage",
  background = styleColorBar(range(0:100), "#76b82a"),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center')
}


#Save results as .csv file
write.csv(Res.dates.m, paste(medicines_less,"medicines_meaning_dates_masked.csv",sep=""), row.names = F)
```


```{r graph_count.dates_m, echo=FALSE}
if (Res.dates.m.1[,.N] != 0){
ggplotly(ggplot(Res.dates.m.1, aes(x = meaning, y = percentage)) +
                               geom_linerange(
                                 aes(x=meaning, ymin=0, ymax=percentage, group= variable_name),
                                 color="gray", size=1.5,
                                 position = position_dodge(0.2)) + 
                              geom_point(
                                aes(color=variable_name),
                                position=position_dodge(0.2), size=2
                              ) +
                              theme_classic() +
                               ggtitle("Counts of date variables by meaning") + 
                               xlab("Meaning") +
                               ylab("Percentage")+
           ylim(0,100) +
                               theme(axis.text.x = element_text(angle = 45),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a")))

}

```

<br>

#### **Counts stratified by meaning and year**

The year variable will be retrieved from each of the dates respectively.    
If `date_dispensing` is completely empty then count and total for this variable will be 0. The same is true for `date_prescription`.   
If both dates are present then the total for `date_dispensing` will be calculated as the complete number of observations of `date_dispensing` and in case of `date_prescription` as the complete number of observations of `date_prescription`.  

If years before 1995 or years in the future are present, they will be colored red.  

```{r count.dates_my, echo=FALSE, warning=FALSE}
#Output for dates count by meaning and year
Res.dates.my<-data.table(table_name="MEDICINES",Results.medicines$DATES_MY)
setnames(Res.dates.my, "variable", "variable_name")
Res.dates.my<-Res.dates.my[(!(is.na(meaning)))]
Res.dates.my<-Res.dates.my[meaning != ""]
Res.dates.my[,year:=as.numeric(year)]
if (nrow(Res.dates.my[(count ==0 & total ==0)])>0) {
  print(paste("There is(are)", nrow(Res.dates.my[(count ==0 & total ==0)]), "row(s) with a zero value for both count and total. Those will not be displayed in the tables or graphs. This happens when a variable is completely missing for a particular meaning category and year."))
}
#Remove rows where both count and total are 0
Res.dates.my<-Res.dates.my[(count !=0 & total !=0)]
Res.dates.my[, percentage:=round((count/total)*100, digits=1)]

#If count>0 and percentage=0, replace percentage with rounded to the 5 level
Res.dates.my[as.numeric(count) > 0 & as.numeric(percentage) == 0, percentage := round((count/total)*100, digits=6)]

#Save results as .csv file
write.csv(Res.dates.my, paste(medicines_dir,"medicines_meaning_year_dates.csv",sep=""),row.names = F)

#Replace counts less than 5 with "<5" and percentage with "N/A"
Res.dates.my[, count:= as.character(count)][as.numeric(count) > 0 & as.numeric(count) < 5, count := "<5"]
Res.dates.my[, percentage:= as.character(percentage)][count == "<5", percentage := "N/A"]
Res.dates.my[, total:= as.character(total)][as.numeric(total) > 0 & as.numeric(total) < 5, total := "<5"]

#Put <5 counts in another dataset for graphs
Res.dates.my.1<-Res.dates.my[count != "<5"]
Res.dates.my.1[, count:= as.numeric(count)]
Res.dates.my.1[, percentage:= as.numeric(percentage)]

if (Res.dates.my[,.N] != 0){
datatable(Res.dates.my, option=list(scrollX=TRUE)) %>% formatStyle("percentage",
  background = styleColorBar(range(0:100), "#76b82a"),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') %>% formatStyle(
  'year', 
  color = styleInterval(c(1995, as.numeric(substr(as.character(Sys.Date()), 1, 4))), c('red', 'black', 'red')),
  fontWeight = styleInterval(c(1995, as.numeric(substr(as.character(Sys.Date()), 1, 4))), c('bold', 'normal', 'bold'))
)
}

#Save results as .csv file
write.csv(Res.dates.my, paste(medicines_less,"medicines_meaning_year_dates_masked.csv",sep=""),row.names = F)
```

If years in the future or before 1995 are present they will not be plotted in the graphs.   

```{r graph_count.dates_my, echo=FALSE, warning=FALSE}
if (Res.dates.my.1[,.N] != 0){
Res.dates.my.graph<-Res.dates.my.1[year<=as.numeric(substr(as.character(Sys.Date()), 1, 4)) & year>=1995]
Res.dates.my.graph[,year:=as.character(year)]
fig.dates.my<-vector(mode="list", length=length(unique(Res.dates.my.graph[["variable_name"]])))
for(i in 1:length(unique(Res.dates.my.graph[["variable_name"]]))) {
  fig.dates.my[[i]]<-ggplotly(ggplot(Res.dates.my.graph[variable_name==unique(Res.dates.my.graph[["variable_name"]])[i]],aes(x = year, y = percentage, group=meaning)) +
                           geom_line(aes(color=meaning)) +
                           geom_point(aes(color=meaning)) +
                               ggtitle(unique(Res.dates.my.graph[["variable_name"]])[i]) + 
                               xlab("Year") +
                               ylab("Percentage")+
                             theme_classic() +
                             ylim(0,100) +
                               theme(axis.text.x = element_text(angle = 90, hjust=1),
                                     axis.title.x = element_text(colour = "#76b82a"),
                                     axis.title.y = element_text(colour = "#76b82a"),
                                     plot.title = element_text(colour = "#76b82a")))
}
}
```

```{r display_graph_count.dates_my, echo=FALSE}
if (Res.dates.my.1[,.N] != 0){
htmltools::tagList(list(fig.dates.my))
}
```

</div>

<br>

<div class = 'box4'>


## 4. Calculations

<br> 

In this section is explained how each count is being calculated.  
Numerator= count  
Denominator= total   
Year= retrieved from the year part of the variable `date_dispensing` or `date_prescription` depending on which one if filled out. In case both are present `date_dispensing` will be used. Exception for dates count stratified by meaning and year where year will be retreived for each of the dates respectively.

```{r echo=FALSE}
calculations_medicines<-data.table(rbind(
  cbind(calculation= "Counts stratified by meaning (other variables)", 
        variable_name=c("person_id", "visit_occurrence_id", "medicinal_product_id", "medicinal_product_atc_code", "disp_number_medicinal_product", "presc_quantity_per_day", "presc_duration_days", "product_lot_number", "indication_code", "prescriber_speciality"), 
        numerator=c("Number of unique persons", "Number of unique visit occurrence id", "Number of 
                    complete observations per meaning category", "Number of complete observations per 
                    meaning category", "Number of complete observations per meaning category", "Number of complete observations per meaning category", "Number of complete observations per
                    meaning category", "Number of complete observations per meaning category", "Number of complete observations per meaning category", "Number of complete observations per meaning category"), 
        denominator=c("Number of total observations with a recorded meaning", "Number of total 
                      observations with a recorded meaning", "Number of total observations with a 
                      recorded meaning", "Number of total observations with a recorded meaning", "Number of total observations with a recorded meaning", "Number of total observations with
                      a recorded meaning", "Number of total observations with a recorded meaning",
                      "Number of total observations with a recorded meaning", "Number of total observations with a recorded meaning", "Number of total observations with a recorded meaning")),
  cbind(calculation="Counts stratified by meaning and year(other variables)", variable_name=c("person_id", "visit_occurrence_id", "medicinal_product_id", "medicinal_product_atc_code", "disp_number_medicinal_product", "presc_quantity_per_day", "presc_duration_days", "product_lot_number", "indication_code", "prescriber_speciality"), 
                         numerator=c("Number of unique persons in a particular year", "Number of unique visit occurrence id in a particular year", "Number of complete observations per meaning category in a particular year", "Number of complete observations per meaning category in a particular year", "Number of complete observations per meaning category in a particular year", "Number of complete observations per meaning category in a particular year", "Number of complete observations per meaning category in a particular year", "Number of complete observations per meaning category in a particular year", "Number of complete observations per meaning category in a particular year", "Number of complete observations per meaning category in a particular year"), 
                         denominator=c("Number of total observations with a recorded meaning in a particular year", "Number of total observations with a recorded meaning in a particular year", "Number of total observations with a recorded meaning in a particular year", "Number of total observations with a recorded meaning in a particular year", "Number of total observations with a recorded meaning in a particular year", "Number of total observations with a recorded meaning in a particular year", "Number of total observations with a recorded meaning in a particular year", "Number of total observations with a recorded meaning in a particular year", "Number of total observations with a recorded meaning in a particular year", "Number of total observations with a recorded meaning in a particular year")),
  cbind(calculation= "Counts stratified by meaning(2 or more categories)",
            variable_name= c("presc_quantity_unit", "indication_code_vocabulary",
                            "meaning_of_drug_record", "origin_of_drug_record", "prescriber_speciality_vocabulary"), 
            numerator= c("Number of complete observations per category", "Number of complete 
            observations per category", "Number of complete observations per category", "Number of
                        complete observations per category", "Number of complete observations per
                        category"), 
            denominator=c("Number of total observations with a recorded meaning", "Number of total
                          observations with a recorded meaning", "Number of total observations with a
                          recorded meaning", "Number of total observations with a recorded meaning",
                          "Number of total observations with a recorded meaning")),
        cbind(calculation= "Counts stratified by meaning and year(2 or more categories)", variable_name=c("presc_quantity_unit", "indication_code_vocabulary",
                            "meaning_of_drug_record", "origin_of_drug_record", "prescriber_speciality_vocabulary"), 
            numerator=c("Number of complete observations per category", "Number of complete observations per category", "Number of complete observations per category", "Number of complete observations per category", "Number of complete observations per category"), 
            denominator=c("Number of total observations with a recorded meaning in a particular year", "Number of total observations with a recorded meaning in a particular year", "Number of total observations with a recorded meaning in a particular year", "Number of total observations with a recorded meaning in a particular year", "Number of total observations with a recorded meaning in a particular year")),
    cbind(calculation= "Date counts stratified by meaning", 
        variable_name=c("date_dispensing", "date_prescription"), 
        numerator=c("Number of complete observations per meaning category", "Number of complete observations per meaning category"), 
        denominator=c("Number of total observations with a recorded meaning", "Number of total observations with a recorded meaning in a particular year")),
  cbind(calculation= "Date counts stratified by meaning and year", 
        variable_name=c("date_dispensing", "date_prescription"), 
        numerator=c("Number of complete observations per meaning category in a particular year", "Number of complete observations per meaning category in a particular year"), 
        denominator=c("Number of total observations with a recorded meaning in a particular year", "Number of total observations with a recorded meaning in a particular year"))
  ))

datatable(calculations_medicines)
```

</div>

<br>

<div class = 'box5'>

## 5. Output folder structure   

If a file is missing that means that it was not possible to calculate it based on the available data.   
   
MEDICINES     
**1.** MEDICINES.html: Rmarkdown report      
**2.** `medicines_meaning_2categories.csv`: counts of variables with 2 or more categories stratified by meaning      
**3.** `medicines_meaning_other.csv`: counts of other variables stratified by meaning      
**4.** `medicines_meaning_year_2categories.csv`: counts of variables with 2 or more categories stratified by meaning and year         
**5.** `medicines_meaning_year_other.csv`: counts of other variables stratified by meaning and year         
**6.** `medicines_meaning_dates.csv`: counts of date variables stratified by meaning        
**7.** `medicines_meaning_year_dates.csv`: counts of date variables stratified by meaning and year    
**8.** `medicines_meaning_dist_disp_num.csv`: distribution of disp_number_medicinal_product stratified by meaning_of_drug_record    
**9.** `medicines_meaning_unit_dist_pres.csv`: distribution of presc_quantity_per_day stratified by meaning_of_drug_record and presc_quantity_unit    
**10.** `medicines_meaning_dist_dur.csv`: distribution of presc_duration_days stratified by meaning_of_drug_record      
**11.** `medicines_meaning_year_dist_disp_num.csv`: distribution of disp_number_medicinal_product stratified by meaning_of_drug_record and date_dispensing    
**12.** `medicines_meaning_unit_year_dist_pres.csv`: distribution of presc_quantity_per_day stratified by meaning_of_drug_record, presc_quantity_unit and date_prescription    
**13.** `medicines_meaning_year_dist_dur.csv`: distribution of presc_duration_days stratified by meaning_of_drug_record and date_prescription    
**14.** Masked:      
&nbsp;&nbsp;&nbsp;&nbsp;***a.*** `medicines_meaning_2categories_masked.csv`: counts of variables with 2 or more categories stratified by meaning where counts smaller than 5 are masked      
&nbsp;&nbsp;&nbsp;&nbsp;***b.*** `medicines_meaning_other_masked.csv`: counts of other variables stratified by meaning where counts smaller than 5 are masked       
&nbsp;&nbsp;&nbsp;&nbsp;***c.*** `medicines_meaning_year_2categories_masked.csv`: counts of variables with 2 or more categories stratified by meaning and year where counts smaller than 5 are masked            
&nbsp;&nbsp;&nbsp;&nbsp;***d.*** `medicines_meaning_year_other_masked.csv`: counts of other variables stratified by meaning and year where counts smaller than 5 are masked     
&nbsp;&nbsp;&nbsp;&nbsp;***e.*** `medicines_meaning_dates_masked.csv`: counts of date variables stratified by meaning where counts smaller than 5 are masked               
&nbsp;&nbsp;&nbsp;&nbsp;***f.*** `medicines_meaning_year_dates_masked.csv`: counts of date variables stratified by meaning and year where counts smaller than 5 are masked     
&nbsp;&nbsp;&nbsp;&nbsp;***g.*** `medicines_meaning_dist_disp_num_masked.csv`: distribution of disp_number_medicinal_product stratified by meaning_of_drug_record where rows with number of total records smaller than 5 are removed    
&nbsp;&nbsp;&nbsp;&nbsp;***h.*** `medicines_meaning_unit_dist_pres_masked.csv`: distribution of presc_quantity_per_day stratified by meaning_of_drug_record and presc_quantity_unit where rows with number of total records smaller than 5 are removed     
&nbsp;&nbsp;&nbsp;&nbsp;***i.*** `medicines_meaning_dist_dur_masked.csv`: distribution of presc_duration_days stratified by meaning_of_drug_record where rows with number of total records smaller than 5 are removed    
&nbsp;&nbsp;&nbsp;&nbsp;***j.*** `medicines_meaning_year_dist_disp_num_masked.csv`: distribution of disp_number_medicinal_product stratified by meaning_of_drug_record and date_dispensing where rows with number of total records smaller than 5 are removed    
&nbsp;&nbsp;&nbsp;&nbsp;***k.*** `medicines_meaning_unit_year_dist_pres_masked.csv`: distribution of presc_quantity_per_day stratified by meaning_of_drug_record, presc_quantity_unit and date_prescription where rows with number of total records smaller than 5 are removed     
&nbsp;&nbsp;&nbsp;&nbsp;***l.*** `medicines_meaning_year_dist_dur_masked.csv`: distribution of presc_duration_days stratified by meaning_of_drug_record and date_prescription where rows with number of total records smaller than 5 are removed      

</div>


  